<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner & Excel Matcher</title>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600&family=Geist+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        .back-nav {
            position: sticky;
            top: 0;
            background: #000;
            color: #fff;
            padding: 16px 20px;
            z-index: 100;
            border-bottom: 1px solid #000;
        }
        
        .back-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        .back-nav a:hover {
            opacity: 0.7;
        }
        
        body {
            font-family: 'Geist', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #000;
            background: #fff;
            font-weight: 400;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        header {
            border-bottom: 1px solid #000;
            padding-bottom: 20px;
            margin-bottom: 40px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: start;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 500;
            letter-spacing: -0.02em;
        }
        
        h2 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .meta {
            font-size: 12px;
            color: #666;
            text-align: right;
            font-family: 'Geist Mono', monospace;
        }
        
        .section {
            border: 1px solid #000;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .grid {
            display: grid;
            gap: 16px;
        }
        
        .grid-2 { grid-template-columns: 1fr 1fr; }
        
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
        
        label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            border: 1px solid #000;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 14px;
            background: #fff;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #000;
            outline-offset: -2px;
        }
        
        textarea {
            font-family: 'Geist Mono', monospace;
            resize: vertical;
            min-height: 120px;
        }
        
        button {
            border: 1px solid #000;
            background: #000;
            color: #fff;
            padding: 8px 16px;
            font-family: inherit;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover { background: #333; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        button.secondary {
            background: #fff;
            color: #000;
        }
        
        button.secondary:hover { background: #f5f5f5; }
        
        button.danger {
            background: #fff;
            color: #d00;
            border-color: #d00;
        }
        
        button.danger:hover { background: #d00; color: #fff; }
        
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .credential-list {
            display: grid;
            gap: 8px;
            margin-top: 16px;
        }
        
        .credential {
            border: 1px solid #000;
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            font-family: 'Geist Mono', monospace;
        }
        
        .credential-info { display: grid; gap: 4px; }
        
        .status {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ccc;
            margin-right: 6px;
        }
        
        .status.active { background: #000; }
        
        .progress-container {
            margin: 16px 0;
            padding: 16px;
            border: 1px solid #000;
            display: none;
        }
        
        .progress-container.visible { display: block; }
        
        .progress-bar-bg {
            height: 2px;
            background: #e0e0e0;
            margin: 8px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: #000;
            width: 0%;
            transition: width 0.3s;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 16px;
            margin-top: 16px;
            font-family: 'Geist Mono', monospace;
            font-size: 11px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 16px;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        
        th {
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 10px;
            background: #f5f5f5;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #000;
        }
        
        .log {
            font-family: 'Geist Mono', monospace;
            font-size: 11px;
            background: #f5f5f5;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 12px;
        }
        
        .mono { font-family: 'Geist Mono', monospace; }
        
        .hide { display: none; }
        
        .alert {
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #000;
            font-size: 12px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 24px;
            border: 2px solid #000;
            max-width: 600px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal h3 {
            font-size: 18px;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .sheet-list, .range-preview {
            border: 1px solid #000;
            max-height: 300px;
            overflow-y: auto;
            margin: 16px 0;
        }

        .sheet-item {
            padding: 12px;
            border-bottom: 1px solid #000;
            cursor: pointer;
            font-family: 'Geist Mono', monospace;
            font-size: 12px;
        }

        .sheet-item:hover {
            background: #f5f5f5;
        }

        .sheet-item.selected {
            background: #000;
            color: #fff;
        }

        /* Scanner Styles */
        .scanner-container {
            position: relative;
            border: 2px solid #000;
            margin: 16px 0;
        }

        #videoElement {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }

        .scan-overlay {
            position: absolute;
            border: 2px solid #000;
            background: rgba(0, 0, 0, 0.1);
            pointer-events: none;
        }

        .scan-controls {
            margin: 16px 0;
        }

        .range-selector {
            width: 100%;
            margin: 8px 0;
        }

        /* Selection Styles */
        .excel-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 11px;
        }

        .excel-table td {
            border: 1px solid #ddd;
            padding: 4px 6px;
            cursor: pointer;
            user-select: none;
        }

        .excel-table td.selected {
            background: #000 !important;
            color: #fff;
        }

        .excel-table td:hover {
            background: #f0f0f0;
        }

        /* Mapping Styles */
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }

        .match-highlight {
            background: #90EE90 !important;
        }

        .partial-match {
            background: #FFE4B5 !important;
        }

        .scan-animation {
            animation: scanPulse 1s ease-in-out infinite;
        }

        @keyframes scanPulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="back-nav">
        <a href="index.html">← Back to Tools</a>
    </nav>

    <div class="container">
        <header>
            <div>
                <h1>QR Code Scanner & Excel Matcher</h1>
                <p>Import Excel data and scan QR/barcodes for automated matching</p>
            </div>
            <div class="meta">
                <div>Last Updated: <span id="lastUpdated">Never</span></div>
                <div>Version: 1.0.0</div>
            </div>
        </header>

        <!-- Stats Section -->
        <div class="stats">
            <div class="stat">
                <span class="stat-value" id="totalScans">0</span>
                Total Scans
            </div>
            <div class="stat">
                <span class="stat-value" id="totalMatches">0</span>
                Matches Found
            </div>
            <div class="stat">
                <span class="stat-value" id="uniqueScans">0</span>
                Unique Codes
            </div>
            <div class="stat">
                <span class="stat-value" id="matchRate">0%</span>
                Match Rate
            </div>
        </div>

        <!-- Import Section -->
        <div class="section" id="importSection">
            <h2>1. Import Excel File</h2>
            <div class="grid">
                <div>
                    <label for="excelFile">Select Excel File (.xlsx, .xls)</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" />
                </div>
                <div class="btn-group">
                    <button id="importBtn" disabled>Import File</button>
                    <button id="clearDataBtn" class="secondary">Clear All Data</button>
                </div>
            </div>
            <div id="importStatus" class="log hide"></div>
        </div>

        <!-- Sheet Selection Modal -->
        <div id="sheetModal" class="modal hide">
            <div class="modal-content">
                <h3>Select Worksheet</h3>
                <div class="sheet-list" id="sheetList"></div>
                <div class="btn-group">
                    <button id="selectSheetBtn" disabled>Select Sheet</button>
                    <button id="cancelSheetBtn" class="secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="section hide" id="previewSection">
            <h2>2. Preview & Select Range</h2>
            <div class="btn-group">
                <button id="selectRangeBtn">Select Data Range</button>
                <button id="useAllDataBtn" class="secondary">Use All Data</button>
            </div>
            <div class="table-container">
                <div id="excelPreview"></div>
            </div>
        </div>

        <!-- Range Selection Modal -->
        <div id="rangeModal" class="modal hide">
            <div class="modal-content">
                <h3>Select Data Range</h3>
                <p>Click and drag to select the data range containing your inventory:</p>
                <div class="range-preview" id="rangePreview"></div>
                <div class="btn-group">
                    <button id="confirmRangeBtn" disabled>Confirm Selection</button>
                    <button id="cancelRangeBtn" class="secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Mapping Section -->
        <div class="section hide" id="mappingSection">
            <h2>3. Map Columns</h2>
            <div class="mapping-grid">
                <div>
                    <label for="mpnColumn">MPN Column</label>
                    <select id="mpnColumn">
                        <option value="">Select Column</option>
                    </select>
                </div>
                <div>
                    <label for="manufacturerColumn">Manufacturer Column</label>
                    <select id="manufacturerColumn">
                        <option value="">Select Column</option>
                    </select>
                </div>
                <div>
                    <label for="designatorsColumn">Designators Column</label>
                    <select id="designatorsColumn">
                        <option value="">Select Column</option>
                    </select>
                </div>
                <div>
                    <label for="quantityColumn">Quantity Column</label>
                    <select id="quantityColumn">
                        <option value="">Select Column</option>
                    </select>
                </div>
            </div>
            <div class="btn-group">
                <button id="saveMappingBtn" disabled>Save Mapping</button>
                <button id="resetMappingBtn" class="secondary">Reset</button>
            </div>
            <div id="mappingPreview" class="table-container hide"></div>
        </div>

        <!-- Scanner Section -->
        <div class="section hide" id="scannerSection">
            <h2>4. QR/Barcode Scanner</h2>
            <div class="scanner-container">
                <video id="videoElement" autoplay playsinline></video>
                <div id="scanOverlay" class="scan-overlay"></div>
            </div>
            <div class="scan-controls">
                <div class="grid grid-2">
                    <div>
                        <label for="scanAreaSize">Scan Area Size</label>
                        <input type="range" id="scanAreaSize" class="range-selector" min="20" max="80" value="50">
                    </div>
                    <div>
                        <label for="scanAreaPosition">Vertical Position</label>
                        <input type="range" id="scanAreaPosition" class="range-selector" min="10" max="70" value="40">
                    </div>
                </div>
                <div class="btn-group">
                    <button id="startScanBtn">Start Scanner</button>
                    <button id="stopScanBtn" class="secondary" disabled>Stop Scanner</button>
                    <button id="resetScanBtn" class="danger">Reset Scans</button>
                </div>
            </div>
            <div id="scanLog" class="log"></div>
        </div>

        <!-- Results Section -->
        <div class="section hide" id="resultsSection">
            <h2>5. Scan Results</h2>
            <div class="table-container">
                <table id="resultsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Scan Time</th>
                            <th>Scanned Code</th>
                            <th>Match Status</th>
                            <th>MPN</th>
                            <th>Manufacturer</th>
                            <th>Designators</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="btn-group">
                <button id="exportResultsBtn" class="secondary">Export Results</button>
                <button id="clearResultsBtn" class="danger">Clear Results</button>
            </div>
        </div>
    </div>

    <script>
        class QRScannerApp {
            constructor() {
                this.excelData = null;
                this.selectedSheet = null;
                this.selectedRange = null;
                this.columnMapping = {};
                this.mappedData = [];
                this.scanResults = [];
                this.isScanning = false;
                this.scanCount = 0;
                this.matchCount = 0;
                this.uniqueScans = new Set();
                this.rangeSelection = { start: null, end: null, selecting: false };
                this.codeReader = null;
                this.stream = null;
                
                this.init();
            }

            init() {
                try {
                    this.setupInitialUI();
                    this.bindAllEvents();
                    this.loadFromStorage();
                    this.updateLastUpdated();
                    this.updateStats();
                    this.logStatus('Application initialized successfully.', 'success');
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showError('Failed to initialize application: ' + error.message);
                }
            }

            setupInitialUI() {
                // Hide all modals and optional sections
                document.getElementById('sheetModal').classList.add('hide');
                document.getElementById('rangeModal').classList.add('hide');
                document.getElementById('previewSection').classList.add('hide');
                document.getElementById('mappingSection').classList.add('hide');
                document.getElementById('scannerSection').classList.add('hide');
                document.getElementById('resultsSection').classList.add('hide');
                
                // Reset button states
                document.getElementById('importBtn').disabled = true;
                document.getElementById('selectSheetBtn').disabled = true;
                document.getElementById('confirmRangeBtn').disabled = true;
                document.getElementById('saveMappingBtn').disabled = true;
                document.getElementById('stopScanBtn').disabled = true;
            }

            bindAllEvents() {
                // File input events
                document.getElementById('excelFile').addEventListener('change', (e) => this.handleFileSelect(e));
                document.getElementById('importBtn').addEventListener('click', () => this.importFile());
                document.getElementById('clearDataBtn').addEventListener('click', () => this.clearAllData());

                // Sheet selection events
                document.getElementById('selectSheetBtn').addEventListener('click', () => this.selectSheet());
                document.getElementById('cancelSheetBtn').addEventListener('click', () => this.cancelSheetSelection());

                // Range selection events
                document.getElementById('selectRangeBtn').addEventListener('click', () => this.openRangeSelection());
                document.getElementById('useAllDataBtn').addEventListener('click', () => this.useAllData());
                document.getElementById('confirmRangeBtn').addEventListener('click', () => this.confirmRangeSelection());
                document.getElementById('cancelRangeBtn').addEventListener('click', () => this.cancelRangeSelection());

                // Column mapping events
                document.getElementById('saveMappingBtn').addEventListener('click', () => this.saveMapping());
                document.getElementById('resetMappingBtn').addEventListener('click', () => this.resetMapping());

                // Scanner events
                document.getElementById('startScanBtn').addEventListener('click', () => this.startScanner());
                document.getElementById('stopScanBtn').addEventListener('click', () => this.stopScanner());
                document.getElementById('resetScanBtn').addEventListener('click', () => this.resetScans());

                // Scanner controls
                document.getElementById('scanAreaSize').addEventListener('input', (e) => this.updateScanArea());
                document.getElementById('scanAreaPosition').addEventListener('input', (e) => this.updateScanArea());

                // Results events
                document.getElementById('exportResultsBtn').addEventListener('click', () => this.exportResults());
                document.getElementById('clearResultsBtn').addEventListener('click', () => this.clearResults());

                // Column mapping change events
                ['mpnColumn', 'manufacturerColumn', 'designatorsColumn', 'quantityColumn'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.validateMapping());
                });
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    document.getElementById('importBtn').disabled = false;
                    this.logStatus(`File selected: ${file.name} (${this.formatFileSize(file.size)})`);
                } else {
                    document.getElementById('importBtn').disabled = true;
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async importFile() {
                const fileInput = document.getElementById('excelFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    this.showError('Please select a file first.');
                    return;
                }

                try {
                    this.logStatus('Reading file...');
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    
                    this.excelData = workbook;
                    this.showSheetSelection(workbook.SheetNames);
                    this.logStatus(`File loaded successfully. Found ${workbook.SheetNames.length} sheet(s).`);
                } catch (error) {
                    this.showError('Error reading file: ' + error.message);
                    console.error('File import error:', error);
                }
            }

            showSheetSelection(sheetNames) {
                const modal = document.getElementById('sheetModal');
                const sheetList = document.getElementById('sheetList');
                
                sheetList.innerHTML = '';
                sheetNames.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'sheet-item';
                    item.textContent = name;
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.sheet-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        this.selectedSheet = name;
                        document.getElementById('selectSheetBtn').disabled = false;
                    });
                    sheetList.appendChild(item);
                });
                
                modal.classList.remove('hide');
            }

            selectSheet() {
                if (!this.selectedSheet) {
                    this.showError('Please select a sheet first.');
                    return;
                }

                try {
                    const worksheet = this.excelData.Sheets[this.selectedSheet];
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    
                    this.logStatus(`Sheet "${this.selectedSheet}" selected. Range: ${worksheet['!ref']}`);
                    this.cancelSheetSelection();
                    this.showPreview(worksheet, range);
                } catch (error) {
                    this.showError('Error processing sheet: ' + error.message);
                    console.error('Sheet selection error:', error);
                }
            }

            cancelSheetSelection() {
                document.getElementById('sheetModal').classList.add('hide');
                document.getElementById('selectSheetBtn').disabled = true;
            }

            showPreview(worksheet, range) {
                const preview = document.getElementById('excelPreview');
                const table = this.createExcelTable(worksheet, range, true);
                preview.innerHTML = '';
                preview.appendChild(table);
                
                document.getElementById('previewSection').classList.remove('hide');
                this.saveToStorage();
            }

            createExcelTable(worksheet, range, interactive = false) {
                const table = document.createElement('table');
                table.className = 'excel-table';
                
                for (let R = range.s.r; R <= Math.min(range.e.r, range.s.r + 19); R++) {
                    const row = document.createElement('tr');
                    
                    for (let C = range.s.c; C <= Math.min(range.e.c, range.s.c + 9); C++) {
                        const cell = document.createElement('td');
                        const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                        const cellData = worksheet[cellRef];
                        
                        cell.textContent = cellData ? cellData.v : '';
                        cell.dataset.row = R;
                        cell.dataset.col = C;
                        
                        if (interactive) {
                            cell.addEventListener('mousedown', (e) => this.startRangeSelection(e));
                            cell.addEventListener('mouseenter', (e) => this.updateRangeSelection(e));
                            cell.addEventListener('mouseup', (e) => this.endRangeSelection(e));
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    table.appendChild(row);
                }
                
                return table;
            }

            openRangeSelection() {
                const worksheet = this.excelData.Sheets[this.selectedSheet];
                const range = XLSX.utils.decode_range(worksheet['!ref']);
                const modal = document.getElementById('rangeModal');
                const preview = document.getElementById('rangePreview');
                
                const table = this.createExcelTable(worksheet, range, true);
                preview.innerHTML = '';
                preview.appendChild(table);
                
                modal.classList.remove('hide');
            }

            startRangeSelection(event) {
                this.rangeSelection.selecting = true;
                this.rangeSelection.start = {
                    row: parseInt(event.target.dataset.row),
                    col: parseInt(event.target.dataset.col)
                };
                this.clearSelections();
                event.target.classList.add('selected');
            }

            updateRangeSelection(event) {
                if (!this.rangeSelection.selecting) return;
                
                this.rangeSelection.end = {
                    row: parseInt(event.target.dataset.row),
                    col: parseInt(event.target.dataset.col)
                };
                
                this.highlightRange();
            }

            endRangeSelection(event) {
                this.rangeSelection.selecting = false;
                this.rangeSelection.end = {
                    row: parseInt(event.target.dataset.row),
                    col: parseInt(event.target.dataset.col)
                };
                
                document.getElementById('confirmRangeBtn').disabled = false;
            }

            highlightRange() {
                this.clearSelections();
                
                if (!this.rangeSelection.start || !this.rangeSelection.end) return;
                
                const startRow = Math.min(this.rangeSelection.start.row, this.rangeSelection.end.row);
                const endRow = Math.max(this.rangeSelection.start.row, this.rangeSelection.end.row);
                const startCol = Math.min(this.rangeSelection.start.col, this.rangeSelection.end.col);
                const endCol = Math.max(this.rangeSelection.start.col, this.rangeSelection.end.col);
                
                const cells = document.querySelectorAll('#rangePreview td');
                cells.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    
                    if (row >= startRow && row <= endRow && col >= startCol && col <= endCol) {
                        cell.classList.add('selected');
                    }
                });
            }

            clearSelections() {
                document.querySelectorAll('#rangePreview td').forEach(cell => {
                    cell.classList.remove('selected');
                });
            }

            confirmRangeSelection() {
                if (!this.rangeSelection.start || !this.rangeSelection.end) {
                    this.showError('Please select a range first.');
                    return;
                }

                const startRow = Math.min(this.rangeSelection.start.row, this.rangeSelection.end.row);
                const endRow = Math.max(this.rangeSelection.start.row, this.rangeSelection.end.row);
                const startCol = Math.min(this.rangeSelection.start.col, this.rangeSelection.end.col);
                const endCol = Math.max(this.rangeSelection.start.col, this.rangeSelection.end.col);

                this.selectedRange = { s: { r: startRow, c: startCol }, e: { r: endRow, c: endCol } };
                
                this.logStatus(`Range selected: ${XLSX.utils.encode_range(this.selectedRange)}`);
                this.cancelRangeSelection();
                this.showMapping();
            }

            cancelRangeSelection() {
                document.getElementById('rangeModal').classList.add('hide');
                document.getElementById('confirmRangeBtn').disabled = true;
            }

            useAllData() {
                const worksheet = this.excelData.Sheets[this.selectedSheet];
                this.selectedRange = XLSX.utils.decode_range(worksheet['!ref']);
                this.logStatus('Using all data from sheet.');
                this.showMapping();
            }

            showMapping() {
                const worksheet = this.excelData.Sheets[this.selectedSheet];
                const headers = this.getHeaders(worksheet, this.selectedRange);
                
                this.populateColumnMappings(headers);
                document.getElementById('mappingSection').classList.remove('hide');
                this.saveToStorage();
            }

            getHeaders(worksheet, range) {
                const headers = [];
                for (let C = range.s.c; C <= range.e.c; C++) {
                    const cellRef = XLSX.utils.encode_cell({ r: range.s.r, c: C });
                    const cellData = worksheet[cellRef];
                    headers.push({
                        index: C,
                        name: cellData ? cellData.v : `Column ${C + 1}`,
                        letter: XLSX.utils.encode_col(C)
                    });
                }
                return headers;
            }

            populateColumnMappings(headers) {
                const selects = ['mpnColumn', 'manufacturerColumn', 'designatorsColumn', 'quantityColumn'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select Column</option>';
                    
                    headers.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header.index;
                        option.textContent = `${header.letter}: ${header.name}`;
                        select.appendChild(option);
                    });
                });
            }

            validateMapping() {
                const mpn = document.getElementById('mpnColumn').value;
                const hasMapping = mpn !== '';
                
                document.getElementById('saveMappingBtn').disabled = !hasMapping;
                
                if (hasMapping) {
                    this.previewMapping();
                }
            }

            previewMapping() {
                const worksheet = this.excelData.Sheets[this.selectedSheet];
                const mappedData = this.extractMappedData(worksheet);
                
                const preview = document.getElementById('mappingPreview');
                preview.innerHTML = '';
                
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>MPN</th>
                            <th>Manufacturer</th>
                            <th>Designators</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${mappedData.slice(0, 10).map(row => `
                            <tr>
                                <td>${row.mpn || '-'}</td>
                                <td>${row.manufacturer || '-'}</td>
                                <td>${row.designators || '-'}</td>
                                <td>${row.quantity || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
                preview.appendChild(table);
                preview.classList.remove('hide');
            }

            extractMappedData(worksheet) {
                const data = [];
                const mpnCol = parseInt(document.getElementById('mpnColumn').value);
                const mfrCol = document.getElementById('manufacturerColumn').value;
                const desCol = document.getElementById('designatorsColumn').value;
                const qtyCol = document.getElementById('quantityColumn').value;

                for (let R = this.selectedRange.s.r + 1; R <= this.selectedRange.e.r; R++) {
                    const row = {
                        mpn: this.getCellValue(worksheet, R, mpnCol),
                        manufacturer: mfrCol ? this.getCellValue(worksheet, R, parseInt(mfrCol)) : '',
                        designators: desCol ? this.getCellValue(worksheet, R, parseInt(desCol)) : '',
                        quantity: qtyCol ? this.getCellValue(worksheet, R, parseInt(qtyCol)) : ''
                    };
                    
                    if (row.mpn && row.mpn.toString().trim()) {
                        data.push(row);
                    }
                }

                return data;
            }

            getCellValue(worksheet, row, col) {
                if (col === undefined || col === '') return '';
                const cellRef = XLSX.utils.encode_cell({ r: row, c: col });
                const cellData = worksheet[cellRef];
                return cellData ? cellData.v : '';
            }

            saveMapping() {
                const worksheet = this.excelData.Sheets[this.selectedSheet];
                this.mappedData = this.extractMappedData(worksheet);
                
                this.columnMapping = {
                    mpn: parseInt(document.getElementById('mpnColumn').value),
                    manufacturer: document.getElementById('manufacturerColumn').value,
                    designators: document.getElementById('designatorsColumn').value,
                    quantity: document.getElementById('quantityColumn').value
                };

                this.logStatus(`Mapping saved. Found ${this.mappedData.length} valid rows.`);
                document.getElementById('scannerSection').classList.remove('hide');
                document.getElementById('resultsSection').classList.remove('hide');
                this.updateScanArea();
                this.saveToStorage();
            }

            resetMapping() {
                this.columnMapping = {};
                this.mappedData = [];
                document.getElementById('mappingPreview').classList.add('hide');
                
                ['mpnColumn', 'manufacturerColumn', 'designatorsColumn', 'quantityColumn'].forEach(id => {
                    document.getElementById(id).selectedIndex = 0;
                });
                
                document.getElementById('saveMappingBtn').disabled = true;
            }

            updateScanArea() {
                const video = document.getElementById('videoElement');
                const overlay = document.getElementById('scanOverlay');
                const sizeRange = document.getElementById('scanAreaSize');
                const posRange = document.getElementById('scanAreaPosition');
                
                if (!video || !overlay) return;
                
                const size = parseInt(sizeRange.value);
                const position = parseInt(posRange.value);
                
                const videoRect = video.getBoundingClientRect();
                const width = (videoRect.width * size) / 100;
                const height = (videoRect.height * size) / 100;
                const left = (videoRect.width - width) / 2;
                const top = (videoRect.height * position) / 100;
                
                overlay.style.width = width + 'px';
                overlay.style.height = height + 'px';
                overlay.style.left = left + 'px';
                overlay.style.top = top + 'px';
            }

            async startScanner() {
                try {
                    if (!this.mappedData.length) {
                        this.showError('Please complete the mapping first.');
                        return;
                    }

                    this.logScan('Starting camera...');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });

                    const video = document.getElementById('videoElement');
                    video.srcObject = stream;
                    this.stream = stream;

                    // Initialize ZXing code reader
                    this.codeReader = new ZXing.BrowserMultiFormatReader();
                    
                    video.onloadedmetadata = () => {
                        this.updateScanArea();
                        this.startDecoding();
                    };

                    document.getElementById('startScanBtn').disabled = true;
                    document.getElementById('stopScanBtn').disabled = false;
                    this.isScanning = true;
                    
                    this.logScan('Scanner started successfully.');
                    
                } catch (error) {
                    this.showError('Camera access failed: ' + error.message);
                    console.error('Scanner start error:', error);
                }
            }

            startDecoding() {
                if (!this.isScanning) return;
                
                const video = document.getElementById('videoElement');
                
                try {
                    this.codeReader.decodeFromVideoDevice(null, video, (result, error) => {
                        if (result && this.isScanning) {
                            const code = result.getText().trim();
                            if (code && !this.isRecentDuplicate(code)) {
                                this.processScan(code);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Decoding error:', error);
                    this.logScan('Decoding error: ' + error.message);
                }
            }

            isRecentDuplicate(code) {
                const recentScans = this.scanResults.slice(-10);
                const recent = recentScans.some(scan => 
                    scan.code === code && 
                    (Date.now() - new Date(scan.timestamp).getTime()) < 2000
                );
                return recent;
            }

            processScan(code) {
                this.scanCount++;
                this.uniqueScans.add(code);
                
                const match = this.findMatch(code);
                const scanResult = {
                    id: this.scanCount,
                    timestamp: new Date().toISOString(),
                    code: code,
                    match: match,
                    status: match ? (match.exact ? 'exact' : 'partial') : 'no_match'
                };

                this.scanResults.push(scanResult);
                
                if (match) {
                    this.matchCount++;
                    this.logScan(`✓ MATCH: ${code} → ${match.mpn}`);
                } else {
                    this.logScan(`✗ NO MATCH: ${code}`);
                }

                this.updateResultsTable();
                this.updateStats();
                this.saveToStorage();
                
                // Visual feedback
                document.getElementById('scanOverlay').classList.add('scan-animation');
                setTimeout(() => {
                    const overlay = document.getElementById('scanOverlay');
                    if (overlay) overlay.classList.remove('scan-animation');
                }, 1000);
            }

            findMatch(scannedCode) {
                const code = scannedCode.toLowerCase().trim();
                
                // Exact match
                for (const item of this.mappedData) {
                    if (item.mpn && item.mpn.toString().toLowerCase().trim() === code) {
                        return { ...item, exact: true };
                    }
                }

                // Partial match (contains)
                for (const item of this.mappedData) {
                    if (item.mpn && (
                        item.mpn.toString().toLowerCase().includes(code) ||
                        code.includes(item.mpn.toString().toLowerCase())
                    )) {
                        return { ...item, exact: false };
                    }
                }

                return null;
            }

            updateResultsTable() {
                const tbody = document.querySelector('#resultsTable tbody');
                const results = [...this.scanResults].reverse().slice(0, 50);
                
                tbody.innerHTML = results.map(result => {
                    const statusClass = result.status === 'exact' ? 'match-highlight' : 
                                      result.status === 'partial' ? 'partial-match' : '';
                    
                    return `
                        <tr class="${statusClass}">
                            <td>${result.id}</td>
                            <td class="mono">${new Date(result.timestamp).toLocaleTimeString()}</td>
                            <td class="mono">${result.code}</td>
                            <td>${result.status.replace('_', ' ').toUpperCase()}</td>
                            <td>${result.match ? result.match.mpn : '-'}</td>
                            <td>${result.match ? result.match.manufacturer : '-'}</td>
                            <td>${result.match ? result.match.designators : '-'}</td>
                            <td>${result.match ? result.match.quantity : '-'}</td>
                        </tr>
                    `;
                }).join('');
            }

            stopScanner() {
                this.isScanning = false;
                
                if (this.codeReader) {
                    this.codeReader.reset();
                    this.codeReader = null;
                }
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }

                const video = document.getElementById('videoElement');
                video.srcObject = null;

                document.getElementById('startScanBtn').disabled = false;
                document.getElementById('stopScanBtn').disabled = true;
                
                this.logScan('Scanner stopped.');
            }

            resetScans() {
                if (confirm('Are you sure you want to clear all scan results?')) {
                    this.scanResults = [];
                    this.scanCount = 0;
                    this.matchCount = 0;
                    this.uniqueScans.clear();
                    
                    this.updateResultsTable();
                    this.updateStats();
                    this.saveToStorage();
                    
                    document.getElementById('scanLog').innerHTML = '';
                    this.logScan('Scan results cleared.');
                }
            }

            updateStats() {
                const matchRate = this.scanCount > 0 ? Math.round((this.matchCount / this.scanCount) * 100) : 0;
                
                document.getElementById('totalScans').textContent = this.scanCount;
                document.getElementById('totalMatches').textContent = this.matchCount;
                document.getElementById('uniqueScans').textContent = this.uniqueScans.size;
                document.getElementById('matchRate').textContent = matchRate + '%';
            }

            exportResults() {
                if (this.scanResults.length === 0) {
                    this.showError('No results to export.');
                    return;
                }

                const csv = this.convertToCSV(this.scanResults);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `scan-results-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.logStatus('Results exported successfully.');
            }

            convertToCSV(data) {
                const headers = ['ID', 'Timestamp', 'Scanned Code', 'Status', 'MPN', 'Manufacturer', 'Designators', 'Quantity'];
                const rows = data.map(result => [
                    result.id,
                    result.timestamp,
                    result.code,
                    result.status,
                    result.match ? result.match.mpn : '',
                    result.match ? result.match.manufacturer : '',
                    result.match ? result.match.designators : '',
                    result.match ? result.match.quantity : ''
                ]);

                return [headers, ...rows].map(row => 
                    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
            }

            clearResults() {
                if (confirm('Are you sure you want to clear all results?')) {
                    this.scanResults = [];
                    this.updateResultsTable();
                    this.saveToStorage();
                    this.logStatus('Results cleared.');
                }
            }

            clearAllData() {
                if (confirm('Are you sure you want to clear all data? This will reset the entire application.')) {
                    this.stopScanner();
                    
                    // Reset all data
                    this.excelData = null;
                    this.selectedSheet = null;
                    this.selectedRange = null;
                    this.columnMapping = {};
                    this.mappedData = [];
                    this.scanResults = [];
                    this.scanCount = 0;
                    this.matchCount = 0;
                    this.uniqueScans.clear();
                    
                    // Reset UI
                    document.getElementById('excelFile').value = '';
                    this.setupInitialUI();
                    this.updateStats();
                    
                    // Clear storage
                    localStorage.removeItem('qrScannerData');
                    
                    this.logStatus('All data cleared.');
                }
            }

            saveToStorage() {
                try {
                    const data = {
                        selectedSheet: this.selectedSheet,
                        selectedRange: this.selectedRange,
                        columnMapping: this.columnMapping,
                        mappedData: this.mappedData,
                        scanResults: this.scanResults,
                        scanCount: this.scanCount,
                        matchCount: this.matchCount,
                        uniqueScans: Array.from(this.uniqueScans),
                        lastUpdated: new Date().toISOString()
                    };
                    
                    localStorage.setItem('qrScannerData', JSON.stringify(data));
                } catch (error) {
                    console.error('Save to storage failed:', error);
                }
            }

            loadFromStorage() {
                try {
                    const data = localStorage.getItem('qrScannerData');
                    if (!data) return;
                    
                    const parsed = JSON.parse(data);
                    
                    this.selectedSheet = parsed.selectedSheet || null;
                    this.selectedRange = parsed.selectedRange || null;
                    this.columnMapping = parsed.columnMapping || {};
                    this.mappedData = parsed.mappedData || [];
                    this.scanResults = parsed.scanResults || [];
                    this.scanCount = parsed.scanCount || 0;
                    this.matchCount = parsed.matchCount || 0;
                    this.uniqueScans = new Set(parsed.uniqueScans || []);
                    
                    if (parsed.lastUpdated) {
                        document.getElementById('lastUpdated').textContent = 
                            new Date(parsed.lastUpdated).toLocaleString();
                    }
                    
                    if (this.scanResults.length > 0) {
                        this.updateResultsTable();
                        document.getElementById('resultsSection').classList.remove('hide');
                    }
                    
                } catch (error) {
                    console.error('Load from storage failed:', error);
                }
            }

            updateLastUpdated() {
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            }

            logStatus(message, type = 'info') {
                const log = document.getElementById('importStatus');
                const timestamp = new Date().toLocaleTimeString();
                log.textContent += `[${timestamp}] ${message}\n`;
                log.scrollTop = log.scrollHeight;
                log.classList.remove('hide');
                console.log(`[QR Scanner] ${message}`);
            }

            logScan(message) {
                const log = document.getElementById('scanLog');
                const timestamp = new Date().toLocaleTimeString();
                log.textContent += `[${timestamp}] ${message}\n`;
                log.scrollTop = log.scrollHeight;
            }

            showError(message) {
                alert('Error: ' + message);
                this.logStatus('ERROR: ' + message, 'error');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new QRScannerApp();
        });

        // Handle page visibility changes to manage camera
        document.addEventListener('visibilitychange', () => {
            if (window.qrApp && document.hidden && window.qrApp.isScanning) {
                window.qrApp.stopScanner();
            }
        });
    </script>
</body>
</html>
