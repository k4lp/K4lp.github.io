<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Digi-Key MPN Analyzer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        .back-nav {
            position: sticky;
            top: 0;
            background: #000;
            color: #fff;
            padding: 16px 20px;
            z-index: 100;
            border-bottom: 1px solid #000;
        }
        
        .back-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }
        
        .back-nav a:hover {
            opacity: 0.7;
        }
        
        body {
            font-family: 'Geist', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #000;
            background: #fff;
            font-weight: 400;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        header {
            border-bottom: 1px solid #000;
            padding-bottom: 20px;
            margin-bottom: 40px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: start;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 500;
            letter-spacing: -0.02em;
        }
        
        h2 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .meta {
            font-size: 12px;
            color: #666;
            text-align: right;
            font-family: 'Geist Mono', monospace;
        }
        
        .section {
            border: 1px solid #000;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .grid {
            display: grid;
            gap: 16px;
        }
        
        .grid-2 { grid-template-columns: 1fr 1fr; }
        
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
        
        label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            border: 1px solid #000;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 14px;
            background: #fff;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #000;
            outline-offset: -2px;
        }
        
        textarea {
            font-family: 'Geist Mono', monospace;
            resize: vertical;
            min-height: 120px;
        }
        
        button {
            border: 1px solid #000;
            background: #000;
            color: #fff;
            padding: 8px 16px;
            font-family: inherit;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover { background: #333; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        button.secondary {
            background: #fff;
            color: #000;
        }
        
        button.secondary:hover { background: #f5f5f5; }
        
        button.danger {
            background: #fff;
            color: #d00;
            border-color: #d00;
        }
        
        button.danger:hover { background: #d00; color: #fff; }
        
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .credential-list {
            display: grid;
            gap: 8px;
            margin-top: 16px;
        }
        
        .credential {
            border: 1px solid #000;
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
            font-size: 12px;
            font-family: 'Geist Mono', monospace;
        }
        
        .credential-info { display: grid; gap: 4px; }
        
        .status {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #ccc;
            margin-right: 6px;
        }
        
        .status.active { background: #000; }
        
        .progress-container {
            margin: 16px 0;
            padding: 16px;
            border: 1px solid #000;
            display: none;
        }
        
        .progress-container.visible { display: block; }
        
        .progress-bar-bg {
            height: 2px;
            background: #e0e0e0;
            margin: 8px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: #000;
            width: 0%;
            transition: width 0.3s;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 16px;
            margin-top: 16px;
            font-family: 'Geist Mono', monospace;
            font-size: 11px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 16px;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        
        th {
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 10px;
            background: #f5f5f5;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #000;
        }
        
        .log {
            font-family: 'Geist Mono', monospace;
            font-size: 11px;
            background: #f5f5f5;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 12px;
        }
        
        .mono { font-family: 'Geist Mono', monospace; }
        
        .hide { display: none; }
        
        .alert {
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #000;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <nav class="back-nav">
        <a href="index.html">‚Üê Back to Tools</a>
    </nav>
    <div class="container">
        <header>
            <div>
                <h1>Digi-Key MPN Analyzer</h1>
                <p style="margin-top: 4px; color: #666; font-size: 13px;">Parallel processing with multiple API credentials</p>
            </div>
            <div class="meta">
                <div>Credentials: <span id="credCount">0</span></div>
                <div>Workers: <span id="workerCount">0</span></div>
            </div>
        </header>

        <section class="section">
            <h2>Credentials</h2>
            
            <div class="grid grid-2">
                <div>
                    <label>Client ID</label>
                    <input type="text" id="clientId" autocomplete="off">
                </div>
                <div>
                    <label>Client Secret</label>
                    <input type="password" id="clientSecret" autocomplete="off">
                </div>
            </div>
            
            <div class="grid grid-2" style="margin-top: 16px;">
                <div>
                    <label>Label</label>
                    <input type="text" id="credLabel" placeholder="Optional">
                </div>
                <div>
                    <label>Environment</label>
                    <select id="environment">
                        <option value="production">Production</option>
                        <option value="sandbox">Sandbox</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 16px;">
                <label>Locale</label>
                <select id="locale">
                    <option value="US/USD">US / USD</option>
                    <option value="CA/CAD">CA / CAD</option>
                    <option value="GB/GBP">GB / GBP</option>
                    <option value="DE/EUR">DE / EUR</option>
                    <option value="JP/JPY">JP / JPY</option>
                </select>
            </div>
            
            <div class="btn-group" style="margin-top: 16px;">
                <button id="addCred">Add</button>
                <button class="secondary" id="authAll">Authenticate All</button>
                <button class="danger" id="clearCreds">Clear All</button>
            </div>
            
            <div id="credList" class="credential-list"></div>
        </section>

        <section class="section">
            <h2>Processing</h2>
            
            <div class="alert">
                Parallel processing distributes requests across multiple authenticated credentials to maximize throughput while respecting API rate limits.
            </div>
            
            <div>
                <label>MPNs (one per line)</label>
                <textarea id="mpnInput" placeholder="ECA-1VHG102&#10;STM32F103C8T6&#10;LM358P"></textarea>
            </div>
            
            <div style="margin-top: 16px;">
                <label>Concurrency per Credential</label>
                <input type="number" id="concurrency" value="3" min="1" max="10">
                <p style="font-size: 11px; color: #666; margin-top: 4px;">Recommended: 2-5</p>
            </div>
            
            <div id="progress" class="progress-container">
                <div id="progressText" class="mono" style="font-size: 11px; margin-bottom: 8px;"></div>
                <div class="progress-bar-bg">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <div class="stats">
                    <div><span class="stat-value" id="statProcessed">0</span> Processed</div>
                    <div><span class="stat-value" id="statSuccess">0</span> Success</div>
                    <div><span class="stat-value" id="statWarning">0</span> Warning</div>
                    <div><span class="stat-value" id="statError">0</span> Error</div>
                    <div><span class="stat-value" id="statRate">0/s</span> Rate</div>
                    <div><span class="stat-value" id="statETA">--</span> ETA</div>
                </div>
            </div>
            
            <div class="btn-group" style="margin-top: 16px;">
                <button id="process">Process</button>
                <button class="secondary" id="export" disabled>Export CSV</button>
                <button class="secondary" id="clear">Clear Results</button>
            </div>
        </section>

        <section class="section">
            <h2>Results</h2>
            <div id="resultsArea">
                <div id="emptyResults" class="empty">No results yet</div>
                <div id="resultsTable" class="table-container hide"></div>
            </div>
        </section>

        <section class="section">
            <h2>Log</h2>
            <div id="log" class="log">System initialized</div>
        </section>
    </div>

    <script>
(function() {
    'use strict';

    // Configuration
    const CONFIG = {
        PRODUCTION: {
            BASE_URL: 'https://api.digikey.com',
            TOKEN_URL: 'https://api.digikey.com/v1/oauth2/token'
        },
        SANDBOX: {
            BASE_URL: 'https://sandbox-api.digikey.com',
            TOKEN_URL: 'https://sandbox-api.digikey.com/v1/oauth2/token'
        },
        STORAGE_KEY: 'dk_creds',
        MIN_DELAY: 100,
        TOKEN_BUFFER: 300000
    };

    // State
    const state = {
        credentials: [],
        results: [],
        isProcessing: false,
        stats: { processed: 0, success: 0, warning: 0, error: 0, startTime: 0 }
    };

    // Utilities
    const $ = id => document.getElementById(id);
    const log = msg => {
        const time = new Date().toLocaleTimeString();
        $('log').textContent += `\n[${time}] ${msg}`;
        $('log').scrollTop = $('log').scrollHeight;
    };
    const uid = () => Math.random().toString(36).substr(2, 9);

    // Credential Manager
    class CredentialManager {
        constructor() {
            this.load();
            this.render();
        }

        add(clientId, clientSecret, env, locale, label) {
            if (!clientId || !clientSecret) return null;
            
            const cred = {
                id: uid(),
                clientId: clientId.trim(),
                clientSecret: clientSecret.trim(),
                environment: env,
                locale: locale,
                label: label || `Credential ${this.count() + 1}`,
                status: 'inactive',
                token: null,
                expiry: null,
                uses: 0
            };

            state.credentials.push(cred);
            this.save();
            this.render();
            log(`Added: ${cred.label}`);
            return cred;
        }

        remove(id) {
            const idx = state.credentials.findIndex(c => c.id === id);
            if (idx > -1) {
                const cred = state.credentials.splice(idx, 1)[0];
                this.save();
                this.render();
                log(`Removed: ${cred.label}`);
            }
        }

        clear() {
            state.credentials = [];
            this.save();
            this.render();
            log('Credentials cleared');
        }

        active() {
            return state.credentials.filter(c => 
                c.status === 'active' && 
                c.token && 
                c.expiry > Date.now()
            );
        }

        setToken(id, token, expiresIn) {
            const cred = state.credentials.find(c => c.id === id);
            if (cred) {
                cred.token = token;
                cred.expiry = Date.now() + (expiresIn * 1000);
                cred.status = 'active';
                this.render();
            }
        }

        markUsed(id) {
            const cred = state.credentials.find(c => c.id === id);
            if (cred) cred.uses++;
        }

        count() {
            return state.credentials.length;
        }

        save() {
            const data = state.credentials.map(c => ({
                id: c.id,
                clientId: c.clientId,
                clientSecret: c.clientSecret,
                environment: c.environment,
                locale: c.locale,
                label: c.label
            }));
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data));
            this.updateMeta();
        }

        load() {
            try {
                const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (stored) {
                    const data = JSON.parse(stored);
                    state.credentials = data.map(c => ({
                        ...c,
                        status: 'inactive',
                        token: null,
                        expiry: null,
                        uses: 0
                    }));
                }
            } catch (e) {
                log('Load error: ' + e.message);
            }
        }

        render() {
            const container = $('credList');
            if (!state.credentials.length) {
                container.innerHTML = '<div class="empty" style="padding: 20px;">No credentials</div>';
            } else {
                container.innerHTML = state.credentials.map(c => {
                    const active = c.status === 'active' && c.token && c.expiry > Date.now();
                    return `
                        <div class="credential">
                            <div class="credential-info">
                                <div><span class="status ${active ? 'active' : ''}"></span>${c.label}</div>
                                <div style="color: #666;">ID: ${c.clientId.substr(0, 20)}...</div>
                                <div style="color: #666;">Uses: ${c.uses} | ${active ? 'Active' : 'Inactive'}</div>
                            </div>
                            <button class="danger" onclick="cm.remove('${c.id}')">Remove</button>
                        </div>
                    `;
                }).join('');
            }
            this.updateMeta();
        }

        updateMeta() {
            $('credCount').textContent = this.count();
            $('workerCount').textContent = this.active().length;
        }
    }

    const cm = new CredentialManager();
    window.cm = cm; // Expose for onclick handlers

    // Authentication
    async function authenticate(cred) {
        try {
            const cfg = cred.environment === 'sandbox' ? CONFIG.SANDBOX : CONFIG.PRODUCTION;
            const res = await fetch(cfg.TOKEN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                    client_id: cred.clientId,
                    client_secret: cred.clientSecret,
                    grant_type: 'client_credentials'
                })
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

            cm.setToken(cred.id, data.access_token, data.expires_in);
            log(`‚úì ${cred.label} authenticated`);
            return true;
        } catch (e) {
            log(`‚úó ${cred.label} failed: ${e.message}`);
            return false;
        }
    }

    async function authenticateAll() {
        if (!cm.count()) {
            alert('No credentials to authenticate');
            return;
        }

        const btn = $('authAll');
        btn.disabled = true;
        btn.textContent = 'Authenticating...';

        let success = 0;
        for (const cred of state.credentials) {
            if (await authenticate(cred)) success++;
            await new Promise(r => setTimeout(r, 500));
        }

        log(`Auth complete: ${success}/${cm.count()}`);
        btn.disabled = false;
        btn.textContent = 'Authenticate All';
    }

    // API Functions
    function getHeaders(cred) {
        const [site, currency] = cred.locale.split('/');
        return {
            'Content-Type': 'application/json',
            'X-DIGIKEY-Client-Id': cred.clientId,
            'Authorization': `Bearer ${cred.token}`,
            'X-DIGIKEY-Locale-Site': site,
            'X-DIGIKEY-Locale-Language': 'en',
            'X-DIGIKEY-Locale-Currency': currency
        };
    }

    async function productDetails(cred, mpn) {
        const cfg = cred.environment === 'sandbox' ? CONFIG.SANDBOX : CONFIG.PRODUCTION;
        const url = `${cfg.BASE_URL}/products/v4/search/${encodeURIComponent(mpn)}/productdetails`;
        const res = await fetch(url, { headers: getHeaders(cred) });
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        cm.markUsed(cred.id);
        return res.json();
    }

    async function keywordSearch(cred, keyword) {
        const cfg = cred.environment === 'sandbox' ? CONFIG.SANDBOX : CONFIG.PRODUCTION;
        const url = `${cfg.BASE_URL}/products/v4/search/keyword`;
        const res = await fetch(url, {
            method: 'POST',
            headers: getHeaders(cred),
            body: JSON.stringify({
                Keywords: keyword,
                RecordCount: 20,
                RecordStartPosition: 0,
                Filters: {},
                Sort: { Option: "SortByManu", Direction: "Ascending", SortParameterId: 0 }
            })
        });
        if (!res.ok) throw new Error(`API error: ${res.status}`);
        cm.markUsed(cred.id);
        return res.json();
    }

    // Data extraction
    function extractParam(params, names) {
        if (!Array.isArray(params)) return '';
        const p = params.find(p => 
            p.ParameterText && names.some(n => 
                p.ParameterText.toLowerCase().includes(n.toLowerCase())
            )
        );
        return p?.ValueText || '';
    }

    // Process single MPN
    async function processMPN(mpn, cred) {
        try {
            // Try direct lookup
            try {
                const data = await productDetails(cred, mpn);
                if (data?.Product) {
                    const p = data.Product;
                    return {
                        status: 'success',
                        mpn,
                        description: p.Description?.ProductDescription || '',
                        detailed: p.Description?.DetailedDescription || '',
                        category: p.Category?.Name || '',
                        manufacturer: p.Manufacturer?.Name || '',
                        package: extractParam(p.Parameters, ['Package', 'Case']),
                        mounting: extractParam(p.Parameters, ['Mounting']),
                        aliases: p.OtherNames?.join(', ') || '',
                        remarks: `Direct via ${cred.label}`
                    };
                }
            } catch (e) {
                // Continue to keyword search
            }

            // Keyword search
            const searchData = await keywordSearch(cred, mpn);
            const products = searchData.Products || [];
            const exact = searchData.ExactMatches || [];

            let match = null;
            let matchType = '';

            if (exact.length > 0) {
                match = exact[0];
                matchType = 'Exact';
            } else {
                match = products.find(p => 
                    p.ManufacturerProductNumber === mpn ||
                    (p.OtherNames && p.OtherNames.includes(mpn))
                );
                if (match) matchType = 'Direct';
            }

            if (!match && products.length > 0) {
                match = products[0];
                matchType = 'Partial';
            }

            if (match) {
                return {
                    status: matchType === 'Partial' ? 'warning' : 'success',
                    mpn,
                    description: match.Description?.ProductDescription || '',
                    detailed: match.Description?.DetailedDescription || '',
                    category: match.Category?.Name || '',
                    manufacturer: match.Manufacturer?.Name || '',
                    package: extractParam(match.Parameters, ['Package', 'Case']),
                    mounting: extractParam(match.Parameters, ['Mounting']),
                    aliases: match.OtherNames?.join(', ') || '',
                    remarks: `${matchType} via ${cred.label}`
                };
            }

            return {
                status: 'error',
                mpn,
                description: '',
                detailed: '',
                category: '',
                manufacturer: '',
                package: '',
                mounting: '',
                aliases: '',
                remarks: `Not found via ${cred.label}`
            };

        } catch (e) {
            return {
                status: 'error',
                mpn,
                description: '',
                detailed: '',
                category: '',
                manufacturer: '',
                package: '',
                mounting: '',
                aliases: '',
                remarks: `Error: ${e.message}`
            };
        }
    }

    // Parallel processor
    class ParallelProcessor {
        constructor(mpns, creds, concurrency) {
            this.mpns = [...mpns];
            this.creds = creds;
            this.concurrency = concurrency;
            this.queue = [...mpns];
            this.results = [];
            this.processing = new Set();
        }

        async process(onProgress) {
            const workers = [];
            for (const cred of this.creds) {
                for (let i = 0; i < this.concurrency; i++) {
                    workers.push(this.worker(cred, onProgress));
                }
            }
            await Promise.all(workers);
            return this.results;
        }

        async worker(cred, onProgress) {
            while (true) {
                const mpn = this.getNext();
                if (!mpn) break;

                await new Promise(r => setTimeout(r, CONFIG.MIN_DELAY));

                try {
                    const result = await processMPN(mpn, cred);
                    this.results.push(result);
                    if (onProgress) onProgress(result);
                } catch (e) {
                    log(`Worker error for ${mpn}: ${e.message}`);
                } finally {
                    this.processing.delete(mpn);
                }
            }
        }

        getNext() {
            while (this.queue.length > 0) {
                const mpn = this.queue.shift();
                if (!this.processing.has(mpn)) {
                    this.processing.add(mpn);
                    return mpn;
                }
            }
            return null;
        }
    }

    // Process bulk
    async function processBulk() {
        const active = cm.active();
        if (!active.length) {
            alert('No active credentials. Authenticate first.');
            return;
        }

        const text = $('mpnInput').value.trim();
        if (!text) {
            alert('Enter at least one MPN');
            return;
        }

        const mpns = text.split('\n').map(m => m.trim()).filter(m => m);
        if (!mpns.length) {
            alert('No valid MPNs');
            return;
        }

        const concurrency = parseInt($('concurrency').value) || 3;

        // Reset
        state.results = [];
        state.stats = { processed: 0, success: 0, warning: 0, error: 0, startTime: Date.now() };
        $('emptyResults').classList.add('hide');
        $('resultsTable').innerHTML = '';
        $('resultsTable').classList.add('hide');
        $('progress').classList.add('visible');
        $('export').disabled = true;

        const btn = $('process');
        btn.disabled = true;
        btn.textContent = 'Processing...';
        state.isProcessing = true;

        try {
            log(`Processing ${mpns.length} MPNs with ${active.length} credential(s)`);

            const processor = new ParallelProcessor(mpns, active, concurrency);

            const onProgress = (result) => {
                state.results.push(result);
                addResult(result);
                
                state.stats.processed++;
                if (result.status === 'success') state.stats.success++;
                else if (result.status === 'warning') state.stats.warning++;
                else state.stats.error++;

                updateProgress(state.stats.processed, mpns.length);
            };

            await processor.process(onProgress);
            log(`‚úì Complete: ${mpns.length} processed`);

        } catch (e) {
            log(`‚úó Error: ${e.message}`);
        } finally {
            state.isProcessing = false;
            btn.disabled = false;
            btn.textContent = 'Process';
            $('export').disabled = false;
        }
    }

    function updateProgress(current, total) {
        const pct = Math.round((current / total) * 100);
        $('progressBar').style.width = pct + '%';
        $('progressText').textContent = `${current} / ${total} (${pct}%)`;

        $('statProcessed').textContent = current;
        $('statSuccess').textContent = state.stats.success;
        $('statWarning').textContent = state.stats.warning;
        $('statError').textContent = state.stats.error;

        const elapsed = (Date.now() - state.stats.startTime) / 1000;
        const rate = current / elapsed;
        $('statRate').textContent = rate.toFixed(1) + '/s';

        const remaining = total - current;
        const eta = remaining / rate;
        if (isFinite(eta) && eta > 0) {
            const m = Math.floor(eta / 60);
            const s = Math.floor(eta % 60);
            $('statETA').textContent = m > 0 ? `${m}m ${s}s` : `${s}s`;
        } else {
            $('statETA').textContent = '--';
        }
    }

    function addResult(r) {
        let table = $('resultsTable');
        
        if (!table.querySelector('table')) {
            table.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>MPN</th>
                            <th>Description</th>
                            <th>Detailed</th>
                            <th>Category</th>
                            <th>Manufacturer</th>
                            <th>Package</th>
                            <th>Mounting</th>
                            <th>Aliases</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            `;
            table.classList.remove('hide');
        }

        const tbody = $('tbody');
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${r.status}</td>
            <td class="mono">${r.mpn}</td>
            <td>${r.description}</td>
            <td>${r.detailed}</td>
            <td>${r.category}</td>
            <td>${r.manufacturer}</td>
            <td>${r.package}</td>
            <td>${r.mounting}</td>
            <td class="mono">${r.aliases}</td>
            <td>${r.remarks}</td>
        `;
    }

    function clearResults() {
        state.results = [];
        state.stats = { processed: 0, success: 0, warning: 0, error: 0, startTime: 0 };
        $('resultsTable').innerHTML = '';
        $('resultsTable').classList.add('hide');
        $('emptyResults').classList.remove('hide');
        $('progress').classList.remove('visible');
        $('export').disabled = true;
        log('Results cleared');
    }

    function exportCSV() {
        if (!state.results.length) {
            alert('No results to export');
            return;
        }

        const headers = ['Status', 'MPN', 'Description', 'Detailed', 'Category', 'Manufacturer', 'Package', 'Mounting', 'Aliases', 'Remarks'];
        const rows = state.results.map(r => [
            r.status,
            `"${r.mpn.replace(/"/g, '""')}"`,
            `"${r.description.replace(/"/g, '""')}"`,
            `"${r.detailed.replace(/"/g, '""')}"`,
            `"${r.category.replace(/"/g, '""')}"`,
            `"${r.manufacturer.replace(/"/g, '""')}"`,
            `"${r.package.replace(/"/g, '""')}"`,
            `"${r.mounting.replace(/"/g, '""')}"`,
            `"${r.aliases.replace(/"/g, '""')}"`,
            `"${r.remarks.replace(/"/g, '""')}"`
        ].join(','));

        const csv = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `digikey-mpn-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        log(`Exported ${state.results.length} results`);
    }

    // Event listeners
    $('addCred').onclick = () => {
        const id = $('clientId').value;
        const secret = $('clientSecret').value;
        const env = $('environment').value;
        const locale = $('locale').value;
        const label = $('credLabel').value;

        if (!id || !secret) {
            alert('Enter Client ID and Secret');
            return;
        }

        cm.add(id, secret, env, locale, label);
        $('clientId').value = '';
        $('clientSecret').value = '';
        $('credLabel').value = '';
    };

    $('authAll').onclick = authenticateAll;
    $('clearCreds').onclick = () => {
        if (confirm('Clear all credentials?')) cm.clear();
    };
    $('process').onclick = processBulk;
    $('export').onclick = exportCSV;
    $('clear').onclick = clearResults;

    log('System ready');
})();
    </script>
</body>
</html>
