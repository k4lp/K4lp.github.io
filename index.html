<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDRS — Gemini Deep Research System</title>
    <meta name="description" content="Browser-based research assistant with iterative reasoning and unlimited code execution">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="app">

        <!-- Header -->
        <header>
            <div class="container-header">
                <div class="brand">
                    <h1>GDRS</h1>
                    <p class="brand-desc">Gemini Deep Research System</p>
                </div>
                <div class="meta">
                    <span class="version">v1.1.4</span>
                    <span class="divider">|</span>
                    <span class="author">Kalp Pariya</span>
                </div>
            </div>
        </header>

        <!-- Sticky Session Status Bar (shown when running) -->
        <div id="sessionStatusBar" class="session-status-bar hidden">
            <div class="status-bar-content">
                <div class="status-bar-left">
                    <span class="status-indicator running"></span>
                    <span class="status-text">RUNNING</span>
                </div>
                <div class="status-bar-center">
                    <span class="status-timer" id="stickySessionTimer">00:00</span>
                </div>
                <div class="status-bar-right">
                    <span class="status-iterations">Iteration <span id="stickyIterationCount">0</span></span>
                    <button id="stickyStopBtn" class="btn btn-sm btn-danger">Stop</button>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <main>
            <div class="container-main">

                <!-- Configuration Panel -->
                <aside class="panel panel-config">

                    <!-- API Keys -->
                    <section class="block collapsible">
                        <header class="block-header">
                            <h2>API Keys</h2>
                            <p class="block-meta">Unlimited • Auto-rotation • Local storage</p>
                            <button class="collapse-toggle" data-target="apiKeysBody">−</button>
                        </header>

                        <div id="apiKeysBody" class="block-body">

                            <div id="keysContainer"></div>

                            <div class="action-group">
                                <button id="validateKeys" class="btn btn-primary">Validate All</button>
                                <button id="clearKeys" class="btn">Clear All</button>
                            </div>

                            <div class="status-bar">
                                <span id="keyRotationPill" class="pill">NO KEY</span>
                                <div id="keyRotationIndicator" class="indicator hidden">
                                    <span class="indicator-icon">↻</span>
                                    <span class="indicator-text">Rotated to #<span id="rotatedKeySlot">0</span></span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Data Attachment Section -->
                    <section class="block collapsible collapsed">
                        <header class="block-header">
                            <div>
                                <h2>Data Attachment</h2>
                                <p class="block-meta">Excel • Runtime only</p>
                            </div>
                            <button class="collapse-toggle" data-target="attachmentBody">+</button>
                        </header>

                        <div id="attachmentBody" class="block-body">
                            <div class="action-group attachment-actions">
                                <span id="attachmentStatusPill" class="pill">NONE</span>
                                <button id="attachmentDownloadOriginal" class="btn btn-sm btn-icon" title="Download original file" disabled>
                                    <span class="icon-large">&#x1f4e5;</span>
                                </button>
                                <button id="attachmentDownloadWorking" class="btn btn-sm btn-icon" title="Save current changes" disabled>
                                    <span class="icon-large">&#x1f4be;</span>
                                </button>
                                <button id="attachmentReset" class="btn btn-sm btn-icon" title="Reset to original" disabled>
                                    <span class="icon-large">&#x21ba;</span>
                                </button>
                                <button id="attachmentRemove" class="btn btn-sm btn-icon" title="Remove attachment" disabled>
                                    <span class="icon-large">&#x1f5d1;</span>
                                </button>
                            </div>
                            <div class="attachment-dropzone" id="attachmentDropzone">
                                <p>Drop .xlsx/.xls/.csv or click</p>
                                <input type="file" id="attachmentInput" accept=".xlsx,.xls,.csv" hidden>
                            </div>

                            <div class="attachment-tabs">
                                <button class="attachment-tab active" data-panel="summary">Summary</button>
                                <button class="attachment-tab" data-panel="sheets">Sheets</button>
                                <button class="attachment-tab" data-panel="mutations">Mutations</button>
                            </div>

                            <div class="attachment-panels">
                                <div class="attachment-panel active" id="attachmentSummaryPanel"></div>
                                <div class="attachment-panel" id="attachmentSheetsPanel"></div>
                                <div class="attachment-panel" id="attachmentMutationsPanel"></div>
                            </div>

                            <div class="attachment-quick-actions" id="attachmentQuickActions">
                                <button class="btn btn-sm" data-action="previewRows" disabled>Preview</button>
                                <button class="btn btn-sm" data-action="logSummary" disabled>Summary</button>
                                <button class="btn btn-sm" data-action="openGuide">Guide</button>
                            </div>
                        </div>
                    </section>

                    <!-- Session Configuration -->
                    <section class="block collapsible">
                        <header class="block-header">
                            <h2>Session</h2>
                            <button class="collapse-toggle" data-target="sessionBody">−</button>
                        </header>

                        <div id="sessionBody" class="block-body">
                            <div class="field">
                                <label for="modelSelect">Model</label>
                                <select id="modelSelect">
                                    <option value="">— select model —</option>
                                </select>
                            </div>

                            <div class="field">
                                <label for="maxOutputTokens">Max Output Tokens</label>
                                <div class="field-with-suffix">
                                    <input id="maxOutputTokens" type="number" value="4096" min="512" max="65536" step="256">
                                    <span class="suffix">tokens</span>
                                </div>
                                <p class="field-hint">512 - 65,536</p>
                            </div>

                            <div class="field checkbox-field">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableSubAgent">
                                    <span>Enable External Knowledge Sub-Agent</span>
                                </label>
                                <p class="field-hint">Allow GDRS to call a lightweight web-research assistant when queries need fresh knowledge.</p>
                            </div>

                            <div class="field checkbox-field">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableExcelHelpers" checked>
                                    <span>Enable Excel Helper Instructions</span>
                                </label>
                                <p class="field-hint">Only include Excel attachment guidance in prompts when this is enabled.</p>
                            </div>

                            <div class="field">
                                <label for="groqApiKeys">Groq API Keys</label>
                                <textarea id="groqApiKeys" rows="3" placeholder="Enter one key per line. Keys are stored locally and used only for Groq requests."></textarea>
                                <p class="field-hint">Needed for live web intelligence requests. Provide multiple keys to allow automatic rotation.</p>
                            </div>

                            <div class="field subagent-status">
                                <div class="subagent-status-header">
                                    <div>
                                        <label>External Knowledge</label>
                                        <p class="field-hint">Latest response from the web sub-agent</p>
                                    </div>
                                    <span id="subAgentStatusPill" class="pill pill-muted">Disabled</span>
                                </div>
                                <div id="subAgentStatusBody" class="subagent-status-body">
                                    <p class="field-hint">Enable the sub-agent toggle to fetch web research automatically.</p>
                                </div>
                            </div>

                            <div class="field">
                                <label for="userQuery">Research Query</label>
                                <textarea id="userQuery" rows="4" placeholder="Enter your research question or task..."></textarea>
                            </div>

                            <div class="action-group">
                                <button id="runQueryBtn" class="btn btn-primary btn-lg btn-with-timer">
                                    <span class="btn-text">Run Analysis</span>
                                    <span id="btnTimer" class="btn-timer hidden">00:00</span>
                                </button>
                                <div class="session-info">
                                    <span id="sessionStatus" class="pill">IDLE</span>
                                    <span id="sessionIterationDisplay" class="session-meta hidden">Iteration 0</span>
                                </div>
                            </div>
                        </div>
                    </section>

                </aside>

                <!-- Processing Panel -->
                <div class="panel panel-process">

                    <!-- Reasoning Log -->
                    <section class="block collapsible" id="reasoningLogSection">
                        <header class="block-header">
                            <div style="display: flex; align-items: center; gap: var(--space-sm); flex: 1;">
                                <h2>Reasoning Log</h2>
                                <p class="block-meta">Iteration <span id="iterationCount">0</span></p>
                            </div>
                            <button class="collapse-toggle" data-target="reasoningLogBody">−</button>
                        </header>

                        <div id="reasoningLogBody" class="block-body">
                            <div id="iterationLog" class="log">
                                <div class="log-placeholder">Intelligent reasoning iterations will appear here</div>
                            </div>
                        </div>
                    </section>

                    <!-- Sub-Agent Console -->
                    <section class="block collapsible" id="subAgentConsoleSection">
                        <header class="block-header">
                            <div style="display: flex; align-items: center; gap: var(--space-sm); flex: 1;">
                                <h2>Sub-Agent Console</h2>
                                <p class="block-meta">Live traces & tools</p>
                            </div>
                            <button class="collapse-toggle" data-target="subAgentConsoleBody">�^'</button>
                        </header>

                        <div id="subAgentConsoleBody" class="block-body">
                            <div id="subAgentTraceBody" class="subagent-trace">
                                <div class="log-placeholder">No sub-agent trace available yet.</div>
                            </div>
                        </div>
                    </section>

                    <!-- Code Execution -->
                    <section class="block collapsible" id="codeExecutionSection">
                        <header class="block-header">
                            <div style="display: flex; align-items: center; gap: var(--space-sm); flex: 1;">
                                <h2>Code Execution</h2>
                                <span id="execStatus" class="pill">READY</span>
                            </div>
                            <button class="collapse-toggle" data-target="codeExecutionBody">−</button>
                        </header>

                        <div id="codeExecutionBody" class="block-body">
                            <div class="code-editor">
                                <textarea id="codeInput" rows="8" spellcheck="false" placeholder="// JavaScript execution environment
console.log('Hello GDRS');
return { status: 'ready', timestamp: new Date() };"></textarea>
                            </div>

                            <div class="action-group">
                                <button id="execBtn" class="btn btn-primary">Execute</button>
                                <button id="clearExec" class="btn">Clear</button>
                            </div>

                            <div class="console">
                                <h3 class="console-label">Console</h3>
                                <pre id="execOutput">Execution output will appear here</pre>
                            </div>
                        </div>
                    </section>

                    <!-- Final Output -->
                    <section class="block">
                        <header class="block-header">
                            <h2>Final Output</h2>
                            <span id="finalStatus" class="pill">IDLE</span>
                        </header>

                        <div class="block-body">
                            <div id="finalOutput" class="output">
                                <div class="output-placeholder">
                                    <p>Research report will render here</p>
                                </div>
                            </div>

                            <div class="action-group">
                                <button id="exportTxt" class="btn">Export Markdown</button>
                            </div>
                        </div>
                    </section>

                </div>

                <!-- Storage Panel -->
                <aside class="panel panel-storage">

                    <!-- Tasks -->
                    <section class="block collapsible">
                        <header class="block-header">
                            <h2>Tasks</h2>
                            <button class="collapse-toggle" data-target="tasksBody">−</button>
                        </header>

                        <div id="tasksBody" class="block-body">
                            <div id="tasksList" class="list">
                                <div class="storage-placeholder">No tasks yet</div>
                            </div>
                        </div>
                    </section>

                    <!-- Memory -->
                    <section class="block collapsible">
                        <header class="block-header">
                            <h2>Memory</h2>
                            <button class="collapse-toggle" data-target="memoryBody">−</button>
                        </header>

                        <div id="memoryBody" class="block-body">
                            <div id="memoryList" class="list">
                                <div class="storage-placeholder">No memories yet</div>
                            </div>
                            <div class="action-group">
                                <button id="clearMemory" class="btn btn-sm">Clear All</button>
                            </div>
                        </div>
                    </section>

                    <!-- Goals -->
                    <section class="block collapsible">
                        <header class="block-header">
                            <h2>Goals</h2>
                            <button class="collapse-toggle" data-target="goalsBody">−</button>
                        </header>

                        <div id="goalsBody" class="block-body">
                            <div id="goalsList" class="list">
                                <div class="storage-placeholder">No goals yet</div>
                            </div>
                            <div class="action-group">
                                <button id="clearGoals" class="btn btn-sm">Clear All</button>
                            </div>
                        </div>
                    </section>

                    <!-- Data Vault -->
                    <section class="block collapsible">
                        <header class="block-header">
                            <h2>Data Vault</h2>
                            <button class="collapse-toggle" data-target="vaultBody">−</button>
                        </header>

                        <div id="vaultBody" class="block-body">
                            <div id="vaultList" class="list">
                                <div class="storage-placeholder">No vault entries yet</div>
                            </div>

                            <div class="action-group">
                                <button id="clearVault" class="btn btn-sm">Clear All</button>
                            </div>

                            <div class="vault-form">
                                <div class="field">
                                    <label for="vaultType">Type</label>
                                    <select id="vaultType">
                                        <option value="text">Text</option>
                                        <option value="code">Code</option>
                                        <option value="data">Data</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="vaultDesc">Description</label>
                                    <input id="vaultDesc" type="text" placeholder="Brief description">
                                </div>
                            </div>
                        </div>
                    </section>

                </aside>

            </div>
        </main>

    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <header class="modal-header">
                <h3>Task Details</h3>
                <button id="taskModalClose" class="modal-close">×</button>
            </header>
            <div class="modal-body">
                <div class="modal-meta">
                    <div class="meta-item">
                        <span class="meta-label">ID</span>
                        <span id="taskModalId" class="meta-value"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Status</span>
                        <span id="taskModalStatus" class="meta-value"></span>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Heading</h4>
                    <p id="taskModalHeading"></p>
                </div>
                <div class="modal-section">
                    <h4>Content</h4>
                    <pre id="taskModalContent"></pre>
                </div>
                <div id="taskModalNotesSection" class="modal-section">
                    <h4>Notes</h4>
                    <pre id="taskModalNotes"></pre>
                </div>
                <div class="modal-actions">
                    <button id="taskModalExport" class="btn btn-sm">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Memory Modal -->
    <div id="memoryModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <header class="modal-header">
                <h3>Memory Details</h3>
                <button id="memoryModalClose" class="modal-close">×</button>
            </header>
            <div class="modal-body">
                <div class="modal-meta">
                    <div class="meta-item">
                        <span class="meta-label">ID</span>
                        <span id="memoryModalId" class="meta-value"></span>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Heading</h4>
                    <p id="memoryModalHeading"></p>
                </div>
                <div class="modal-section">
                    <h4>Content</h4>
                    <pre id="memoryModalContent"></pre>
                </div>
                <div id="memoryModalNotesSection" class="modal-section">
                    <h4>Notes</h4>
                    <pre id="memoryModalNotes"></pre>
                </div>
                <div class="modal-actions">
                    <button id="memoryModalExport" class="btn btn-sm">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Goal Modal -->
    <div id="goalModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <header class="modal-header">
                <h3>Goal Details</h3>
                <button id="goalModalClose" class="modal-close">×</button>
            </header>
            <div class="modal-body">
                <div class="modal-meta">
                    <div class="meta-item">
                        <span class="meta-label">ID</span>
                        <span id="goalModalId" class="meta-value"></span>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Heading</h4>
                    <p id="goalModalHeading"></p>
                </div>
                <div class="modal-section">
                    <h4>Content</h4>
                    <pre id="goalModalContent"></pre>
                </div>
                <div id="goalModalNotesSection" class="modal-section">
                    <h4>Notes</h4>
                    <pre id="goalModalNotes"></pre>
                </div>
                <div class="modal-actions">
                    <button id="goalModalExport" class="btn btn-sm">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vault Modal -->
    <div id="vaultModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <header class="modal-header">
                <h3>Vault Entry</h3>
                <button id="vaultModalClose" class="modal-close">×</button>
            </header>
            <div class="modal-body">
                <div class="modal-meta">
                    <div class="meta-item">
                        <span class="meta-label">ID</span>
                        <span id="vaultModalId" class="meta-value"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Type</span>
                        <span id="vaultModalType" class="meta-value"></span>
                    </div>
                </div>
                <div class="modal-section">
                    <h4>Description</h4>
                    <p id="vaultModalDesc"></p>
                </div>
                <div class="modal-section">
                    <h4>Content</h4>
                    <pre id="vaultModalContent"></pre>
                </div>
                <div class="modal-actions">
                    <button id="vaultModalExport" class="btn btn-sm">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>

    <!-- SheetJS for Excel attachment functionality -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Scripts -->
    <script src="js/main.js" type="module"></script>

</body>
</html>
