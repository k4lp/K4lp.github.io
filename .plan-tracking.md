# Implementation Plan Tracking Document
## Project: UI/UX Improvements + Excel API + System Instructions Update

---

## üìç CRITICAL FILE BINDINGS

### **UI Components**
| Component | File | Key Elements | Current State |
|-----------|------|--------------|---------------|
| Reasoning Log Renderer | `/js/ui/renderer/renderer-reasoning.js` | `renderReasoningLog()` (L15-74) | No collapse toggle |
| Tool Activity Renderer | `/js/ui/renderer/renderer-helpers.js` | `renderToolActivities()` (L98-148) | Renders activity blocks |
| Main HTML Structure | `/index.html` | Reasoning Log (L175-185), Code Execution (L187-211) | Static sections |
| Stylesheet | `/styles.css` | `.block`, `.block-header`, `.collapse-toggle` (L336-398) | Has collapse styles |

### **Excel API**
| Component | File | Key Elements | Current State |
|-----------|------|--------------|---------------|
| Sheet Operations | `/js/excel/api/sheet-operations.js` | `clampChar()` (L13-19), read methods | Default: 50 chars |
| Excel Store | `/js/excel/core/excel-store.js` | `DEFAULT_CHAR_LIMIT = 50` (L10) | Single default limit |
| Attachments Provider | `/js/reasoning/context/providers/attachments-provider.js` | Excel API Reference (L7-47), Exploration Guide (L49-181) | Current instructions |

### **System Configuration**
| Component | File | Key Elements | Current State |
|-----------|------|--------------|---------------|
| System Prompt | `/js/config/app-config.js` | SYSTEM_PROMPT (L37-255), Excel Protocol (L100-106) | Missing datavault reference requirement |

### **Attachment UI**
| Component | File | Key Elements | Current State |
|-----------|------|--------------|---------------|
| Attachment Buttons | `/index.html` | Download/Reset/Remove buttons (L96-99) | Small icons: ‚§ì, ‚§ì*, ‚Ü∫, ‚úï |
| Attachment Styles | `/styles.css` | `.attachment-dropzone` (L1227-1302) | Current button styling |

---

## üéØ TASK BREAKDOWN

### **PHASE 1: UI IMPROVEMENTS - Collapsible Sections**

#### Task 1.1: Add Collapsible Toggle to Reasoning Log Section
**Files to Modify:**
- `/index.html` (L175-185)

**Changes:**
- Add collapse toggle button to Reasoning Log header
- Add `collapsible` class to section
- Add `data-target` attribute for collapse logic

**Existing Collapse System:**
- CSS classes already exist: `.collapse-toggle`, `.collapsible`, `.collapsed`
- Toggle button template exists in Attachment section (L90)

**Implementation:**
```html
<section class="block collapsible" id="reasoningLogSection">
    <header class="block-header">
        <div style="display: flex; align-items: center; gap: var(--space-sm);">
            <h2>Reasoning Log</h2>
            <p class="block-meta">Iteration <span id="iterationCount">0</span></p>
        </div>
        <button class="collapse-toggle" data-target="reasoningLogBody">‚àí</button>
    </header>
    <div id="reasoningLogBody" class="block-body">
        ...existing content...
    </div>
</section>
```

---

#### Task 1.2: Add Collapsible Toggle to Code Execution Section
**Files to Modify:**
- `/index.html` (L187-211)

**Changes:**
- Add collapse toggle button to Code Execution header
- Add `collapsible` class to section
- Add `data-target` attribute

**Implementation:**
```html
<section class="block collapsible" id="codeExecutionSection">
    <header class="block-header">
        <div style="display: flex; align-items: center; gap: var(--space-sm);">
            <h2>Code Execution</h2>
            <span id="execStatus" class="pill">READY</span>
        </div>
        <button class="collapse-toggle" data-target="codeExecutionBody">‚àí</button>
    </header>
    <div id="codeExecutionBody" class="block-body">
        ...existing content...
    </div>
</section>
```

---

#### Task 1.3: Verify/Implement Collapse Toggle JavaScript
**Files to Check/Modify:**
- `/js/ui/handlers/handler-core.js` or similar

**Required Functionality:**
- Click handler for `.collapse-toggle` buttons
- Toggle between `+` and `‚àí` symbols
- Toggle `.collapsed` class on parent `.collapsible` element
- Persist collapse state in localStorage (optional enhancement)

**Expected Behavior:**
- Collapsed: `.block-body` hidden, toggle shows `+`
- Expanded: `.block-body` visible, toggle shows `‚àí`

---

### **PHASE 2: UI IMPROVEMENTS - Attachment Button Icons**

#### Task 2.1: Update Attachment Button Icons and Sizes
**Files to Modify:**
- `/index.html` (L96-99)
- `/styles.css` (attachment button styles)

**Current Icons:**
- ‚§ì (Download Original) ‚Üí Change to üì• or ‚¨áÔ∏è with larger size
- ‚§ì* (Download Working) ‚Üí Change to üíæ or üì§ with larger size
- ‚Ü∫ (Reset) ‚Üí Change to üîÑ with larger size
- ‚úï (Remove) ‚Üí Change to üóëÔ∏è or ‚ùå with larger size

**Recommended Icons (More Self-Explanatory):**
- Download Original: üì• "Download Original"
- Download Working: üíæ "Save Changes"
- Reset: üîÑ "Reset to Original"
- Remove: üóëÔ∏è "Remove File"

**Implementation:**
```html
<div class="action-group attachment-actions">
    <span id="attachmentStatusPill" class="pill">NONE</span>
    <button id="attachmentDownloadOriginal" class="btn btn-sm btn-icon" title="Download original file" disabled>
        <span class="btn-icon-large">üì•</span>
    </button>
    <button id="attachmentDownloadWorking" class="btn btn-sm btn-icon" title="Download with changes" disabled>
        <span class="btn-icon-large">üíæ</span>
    </button>
    <button id="attachmentReset" class="btn btn-sm btn-icon" title="Reset to original" disabled>
        <span class="btn-icon-large">üîÑ</span>
    </button>
    <button id="attachmentRemove" class="btn btn-sm btn-icon" title="Remove attachment" disabled>
        <span class="btn-icon-large">üóëÔ∏è</span>
    </button>
</div>
```

**CSS Addition:**
```css
.btn-icon-large {
  font-size: 1.125rem; /* 18px - larger than current */
  display: inline-block;
  line-height: 1;
}

.btn-icon {
  min-width: 36px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
```

---

### **PHASE 3: UI IMPROVEMENTS - Reasoning Log Display**

#### Task 3.1: Add Proper Borders to Reasoning Blocks
**Files to Modify:**
- `/styles.css` (add new styles for reasoning blocks)

**Current Issue:**
- Steps are merged without visual separation
- No distinct borders between reasoning iterations

**Implementation:**
Add new CSS rules:
```css
/* Reasoning Block Styling */
.reasoning-block {
  margin-bottom: var(--space-lg);
  padding: var(--space-md);
  background: var(--white);
  border: 2px solid var(--gray-300);
  border-left: 4px solid var(--gray-900);
}

.reasoning-block.even {
  background: var(--gray-50);
  border-left-color: var(--gray-700);
}

.reasoning-block.odd {
  background: var(--white);
  border-left-color: var(--gray-900);
}

.reasoning-block.reasoning-type {
  border-left-color: #0066cc; /* Blue for reasoning */
}

.reasoning-block .block-header {
  margin-bottom: var(--space-sm);
  padding-bottom: var(--space-sm);
  border-bottom: 1px solid var(--gray-300);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.reasoning-block .block-header.reasoning {
  border-bottom-color: var(--gray-400);
}

.reasoning-block .block-header.activity {
  border-bottom-color: var(--gray-300);
}
```

---

#### Task 3.2: Improve Code Execution Block Styling
**Files to Modify:**
- `/styles.css` (execution block styles)
- `/js/ui/renderer/renderer-reasoning.js` (if needed for structure)

**Current Issue:**
- Code execution and output not properly designed
- No clear distinction between CODE/OUTPUT/ERROR sections

**Implementation:**
```css
/* Execution Block Styling */
.execution-block {
  margin: var(--space-sm) 0;
  padding: var(--space-md);
  font-family: var(--font-mono);
  font-size: 0.6875rem;
  background: var(--gray-900);
  color: var(--gray-100);
  border-left: 4px solid #00ff00; /* Electric green accent */
  overflow-x: auto;
}

.execution-block[data-section="code"] {
  border-left-color: #0099ff; /* Blue for code */
  background: #1a1a1a;
}

.execution-block[data-section="console-output"] {
  border-left-color: #00ff00; /* Green for output */
  background: #0d1117;
}

.execution-block[data-section="return-value"] {
  border-left-color: #9933ff; /* Purple for return */
  background: #1a1a1a;
}

.execution-block[data-section="error"] {
  border-left-color: #ff3366; /* Red for errors */
  background: #2a0a0a;
  color: #ffcccc;
}

.execution-block[data-section="stack"] {
  border-left-color: #ff9933; /* Orange for stack */
  background: #1a1a1a;
  color: #ffddaa;
}
```

---

#### Task 3.3: Improve Action Block Styling
**Files to Modify:**
- `/styles.css` (activity/action styles)
- `/js/ui/renderer/renderer-helpers.js` (structure already exists)

**Current Issue:**
- Actions look ugly
- No visual hierarchy

**Implementation:**
```css
/* Activity Type Specific Styling */
.reasoning-block.execution-type {
  border-left-color: #00ff00;
  background: linear-gradient(to right, rgba(0, 255, 0, 0.05), transparent);
}

.reasoning-block.vault-type {
  border-left-color: #9933ff;
  background: linear-gradient(to right, rgba(153, 51, 255, 0.05), transparent);
}

.reasoning-block.memory-type {
  border-left-color: #0099ff;
  background: linear-gradient(to right, rgba(0, 153, 255, 0.05), transparent);
}

.reasoning-block.task-type {
  border-left-color: #00cc66;
  background: linear-gradient(to right, rgba(0, 204, 102, 0.05), transparent);
}

.reasoning-block.goal-type {
  border-left-color: #ff6600;
  background: linear-gradient(to right, rgba(255, 102, 0, 0.05), transparent);
}

.reasoning-block.output-type {
  border-left-color: #cc0099;
  background: linear-gradient(to right, rgba(204, 0, 153, 0.05), transparent);
}

/* Activity Icons */
.activity-icon {
  font-size: 1.25rem;
  margin-right: var(--space-xs);
  filter: grayscale(0%);
}

/* Activity Header Styling */
.block-header .header-left {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.block-header .header-right {
  display: flex;
  align-items: center;
  gap: var(--space-xs);
}

.block-title {
  font-size: 0.6875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--gray-900);
}

.block-meta-compact {
  font-size: 0.625rem;
  font-family: var(--font-mono);
  color: var(--gray-600);
}

.status-badge-compact {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: 50%;
  background: var(--gray-200);
  color: var(--gray-700);
}

.status-badge-compact.success {
  background: rgba(0, 204, 102, 0.2);
  color: #00804d;
}

.status-badge-compact.error {
  background: rgba(255, 51, 102, 0.2);
  color: #cc0000;
}
```

---

#### Task 3.4: Improve Task Update Separation
**Files to Modify:**
- `/styles.css` (task/goal/memory rendering)

**Current Issue:**
- Task updates need proper visual separation

**Implementation:**
```css
/* Iteration Badge Styling */
.iteration-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 32px;
  height: 24px;
  padding: 0 var(--space-xs);
  font-family: var(--font-mono);
  font-size: 0.6875rem;
  font-weight: 600;
  background: var(--gray-900);
  color: var(--white);
  border-radius: 2px;
}

/* Activity Body */
.activity-body {
  padding: var(--space-sm) var(--space-md);
  background: rgba(0, 0, 0, 0.02);
  border-top: 1px solid var(--gray-200);
}

.activity-error {
  display: flex;
  align-items: flex-start;
  gap: var(--space-sm);
  padding: var(--space-sm);
  background: rgba(255, 51, 102, 0.1);
  border-left: 3px solid #ff3366;
}

.error-icon {
  font-size: 1rem;
  color: #ff3366;
  flex-shrink: 0;
}

.error-message {
  font-size: 0.6875rem;
  font-family: var(--font-mono);
  color: #cc0000;
  line-height: 1.5;
}
```

---

### **PHASE 4: EXCEL API - Character Limit Changes**

#### Task 4.1: Update Default Character Limits
**Files to Modify:**
- `/js/excel/core/excel-store.js` (L10)
- `/js/excel/api/sheet-operations.js` (L13-19)

**Current State:**
```javascript
// excel-store.js
const DEFAULT_CHAR_LIMIT = 50;

// sheet-operations.js
function clampChar(value, charLimit = ATTACHMENT_DEFAULT_CHAR_LIMIT) {
  // Uses 50 as default
}
```

**New Implementation:**

**Option A: Two Separate Defaults (Recommended)**
```javascript
// excel-store.js
const DEFAULT_CHAR_LIMIT_PREVIEW = 50;  // For quick scans/previews
const DEFAULT_CHAR_LIMIT_READ = Infinity;  // For read operations
```

**Option B: Keep Single Default, Update Documentation**
- Keep default at 50 for backward compatibility
- Update prompts to explicitly request `charLimit: Infinity` for read operations

**Recommendation:** Option B with enhanced documentation

---

#### Task 4.2: Update Excel API Reference Prompt
**Files to Modify:**
- `/js/reasoning/context/providers/attachments-provider.js` (L7-47)

**Current Text (L37-43):**
```javascript
3. Character Limits:
   - **Default: 50 chars** per cell (use for initial scans)
   - **Medium: 100 chars** (when you need more context)
   - **Large: 200 chars** (for longer text fields)
   - **UNLIMITED: Infinity** (for copy-paste operations, full content extraction)
```

**New Text:**
```javascript
3. **Character Limits - CRITICAL DISTINCTION:**
   - **DEFAULT: 50 chars** - For PREVIEW/EXPLORATION only (when you just want to see data structure)
     - Use when: Initial scan, understanding schema, checking data types
     - Example: "I just want to see what's in this sheet"

   - **UNLIMITED: Infinity** - For READ/OPERATIONS (when you need to work with actual data)
     - Use when: Extracting data, performing calculations, copying values, generating output
     - Example: "I need to process this data", "Extract all values", "Calculate totals"
     - **THIS SHOULD BE THE DEFAULT FOR ANY ACTUAL DATA OPERATIONS**

   - **Custom: 100 or 200 chars** - For moderate previews with more context
     - Use when: Long text fields need more visibility but not full content

   **RULE OF THUMB:**
   - Looking at data? ‚Üí charLimit: 50
   - Working with data? ‚Üí charLimit: Infinity
```

---

#### Task 4.3: Update Excel Exploration Guide
**Files to Modify:**
- `/js/reasoning/context/providers/attachments-provider.js` (L49-181)

**Add New Section After Line 138 (after "Scan Multiple Sheets" example):**
```javascript
**CRITICAL: ALWAYS SCAN BEGINNING AND END**
\`\`\`javascript
// ‚ö†Ô∏è MANDATORY WORKFLOW FOR DATA EXPLORATION ‚ö†Ô∏è

// STEP 1: Get dimensions
const sheet = attachments.getSheet(0);
const summary = sheet.summary();

// STEP 2: ALWAYS scan BEGINNING (first 10-20 rows)
const beginning = sheet.getRowsAsObjects({
  offset: 0,
  limit: 15,
  charLimit: 50  // Preview only
});
console.log('BEGINNING:', beginning);

// STEP 3: ALWAYS scan END (last 10-20 rows)
const endOffset = Math.max(0, summary.rowCount - 15);
const ending = sheet.getRowsAsObjects({
  offset: endOffset,
  limit: 15,
  charLimit: 50  // Preview only
});
console.log('ENDING:', ending);

// STEP 4: IF NEEDED (for large datasets), scan middle
if (summary.rowCount > 100) {
  const middleOffset = Math.floor(summary.rowCount / 2) - 10;
  const middle = sheet.getRowsAsObjects({
    offset: middleOffset,
    limit: 20,
    charLimit: 50
  });
  console.log('MIDDLE SECTION:', middle);
}

// STEP 5: Understand user query and data contents
// Now that you've seen beginning/end/middle, you know:
// - Data range and structure
// - Column types and formats
// - Whether data is sorted or unsorted
// - Presence of headers, footers, or summary rows

// STEP 6: If query requires OPERATIONS on data, read with Infinity
if (userWantsDataExtraction || userWantsCalculations) {
  // Get complete data for processing
  const fullData = sheet.getRowsAsObjects({
    offset: 0,
    limit: summary.rowCount,
    charLimit: Infinity  // ‚úÖ COMPLETE DATA
  });
  vault.set('full_dataset', fullData);
}
\`\`\`
```

**Update "CHARACTER LIMIT STRATEGY" Section (L139-143):**
```javascript
**CHARACTER LIMIT STRATEGY - UPDATED:**
- **50 chars (PREVIEW MODE)**:
  - Initial exploration ONLY
  - Understanding structure, checking what data exists
  - Answering: "What does this sheet contain?"
  - ‚ùå DO NOT use for actual data operations

- **Infinity (OPERATION MODE)**:
  - **DEFAULT for ANY data operation**
  - Extracting, calculating, processing, copying, exporting
  - When user asks: "Get all X", "Calculate Y", "Find Z"
  - ‚úÖ ALWAYS use for actual work with data

- **100-200 chars (CONTEXTUAL PREVIEW)**:
  - When preview needs more context (descriptions, notes)
  - Exploratory phase with longer text fields

**DECISION TREE:**
```
User Query ‚Üí "Just show me the data" ‚Üí charLimit: 50
User Query ‚Üí "Extract/Process/Calculate" ‚Üí charLimit: Infinity
User Query ‚Üí "What's in column X?" ‚Üí charLimit: 50 first, then Infinity if needed
```
```

---

#### Task 4.4: Update "WHEN TO USE UNLIMITED" Section
**Files to Modify:**
- `/js/reasoning/context/providers/attachments-provider.js` (L145-166)

**Replace Entire Section:**
```javascript
**WHEN TO USE charLimit: Infinity (CRITICAL - READ CAREFULLY):**

**‚úÖ ALWAYS USE FOR:**
1. **Data Extraction**: "Get all product names", "Extract email addresses"
2. **Calculations**: "Sum total sales", "Calculate averages", "Count unique values"
3. **Data Operations**: "Filter rows where...", "Find duplicates", "Merge columns"
4. **Copy/Export**: "Generate CSV", "Create report", "Export to vault"
5. **Comparisons**: "Compare Sheet1 vs Sheet2", "Find differences"
6. **Search**: "Find rows containing X", "Search for pattern Y"

**‚ùå ONLY USE 50 chars FOR:**
1. **Initial reconnaissance**: "What's in this workbook?"
2. **Schema exploration**: "What are the column names?"
3. **Data type checking**: "Is this column numeric or text?"
4. **Quick preview**: "Show me first few rows"

**EXAMPLES:**

\`\`\`javascript
// ‚ùå WRONG - Using preview mode for actual work
const data = sheet.getColumnData({
  columnIndex: 0,
  charLimit: 50  // ‚ùå This truncates data!
});
const sum = data.reduce((a, b) => a + parseFloat(b), 0); // ‚ùå WRONG CALCULATION

// ‚úÖ CORRECT - Using unlimited for operations
const data = sheet.getColumnData({
  columnIndex: 0,
  charLimit: Infinity  // ‚úÖ Complete data
});
const sum = data.reduce((a, b) => a + parseFloat(b || 0), 0); // ‚úÖ CORRECT

// ‚úÖ CORRECT - Preview first, then read full
// Step 1: Preview to understand structure
const preview = sheet.sliceRows({ limit: 10, charLimit: 50 });
console.log('Preview:', preview);

// Step 2: Read full data for actual work
const fullData = sheet.sliceRows({
  offset: 0,
  limit: summary.rowCount,
  charLimit: Infinity  // ‚úÖ Get everything
});
vault.set('complete_data', fullData);
\`\`\`

**MEMORY AID:**
- **Peeking** at data = charLimit: 50
- **Working** with data = charLimit: Infinity
```

---

#### Task 4.5: Update "BEST PRACTICES" Section
**Files to Modify:**
- `/js/reasoning/context/providers/attachments-provider.js` (L168-181)

**Update Section:**
```javascript
**BEST PRACTICES (UPDATED):**
‚úÖ ALWAYS read summary first: \`const summary = sheet.summary()\`
‚úÖ **ALWAYS scan BEGINNING and END of sheet** before reading all data
‚úÖ If sheet > 100 rows, scan MIDDLE section too (beginning/middle/end)
‚úÖ Use charLimit: 50 ONLY for exploration/preview phase
‚úÖ **Use charLimit: Infinity for ANY data operation** (extract, calculate, process)
‚úÖ Store large results in Vault: \`vault.set('data', result)\`
‚úÖ Use offset/limit to avoid loading entire sheets at once (max 200 rows/call)
‚úÖ For datasets > 1000 rows, use strategic sampling (beginning/middle/end)

‚ùå NEVER dump entire sheets to console (use vault)
‚ùå NEVER use limit > 200 rows per call
‚ùå **NEVER skip scanning the END of the sheet** (data might be at bottom)
‚ùå NEVER assume data is clean - always filter nulls/empties
‚ùå **NEVER use charLimit: 50 for calculations or data operations**
‚ùå NEVER guess data structure - always check beginning AND end
```

---

### **PHASE 5: SYSTEM INSTRUCTIONS - DataVault References**

#### Task 5.1: Add DataVault Reference Requirement to System Prompt
**Files to Modify:**
- `/js/config/app-config.js` (L124-130)

**Current Text (L124-130):**
```javascript
## TASK & GOAL LIFECYCLE

- Create tasks as soon as you identify discrete workstreams; include heading, purpose, and completion criteria. Status must progress \`pending -> ongoing -> finished\` (or \`paused\` when blocked).
- Only run one task at a time. If new work appears, enqueue it as a new task instead of context-switching silently.
- Goals capture strategic success criteria and validation checkpoints. Update them when requirements evolve and reference them when verifying completion.
- Use Memory for durable context (insights, assumptions, constraints) and the DataVault for bulky artefacts (datasets, code, transcripts) so tasks/goals stay lean.
```

**Updated Text:**
```javascript
## TASK & GOAL LIFECYCLE

- Create tasks as soon as you identify discrete workstreams; include heading, purpose, and completion criteria. Status must progress \`pending -> ongoing -> finished\` (or \`paused\` when blocked).
- **CRITICAL: When creating Tasks or Goals, ALWAYS include DataVault reference names in the heading or notes if the task/goal relates to vault data.** Example: "Task: Analyze customer data [vault:customer_dataset]" or "Goal: Validate pricing model using [vault:price_matrix]"
- Only run one task at a time. If new work appears, enqueue it as a new task instead of context-switching silently.
- Goals capture strategic success criteria and validation checkpoints. Update them when requirements evolve and reference them when verifying completion.
- **When referencing data in Tasks/Goals, cite the vault entry:** "Extract top 10 products from [vault:sales_data]"
- Use Memory for durable context (insights, assumptions, constraints) and the DataVault for bulky artefacts (datasets, code, transcripts) so tasks/goals stay lean.
```

---

#### Task 5.2: Update Task Tool Format Documentation
**Files to Modify:**
- `/js/config/app-config.js` (L141-144)

**Current Text:**
```javascript
### Task Tool
- **Format**: \`{{<task identifier="task_id" heading="Title" content="Work description" status="pending|ongoing|finished|paused" notes="Progress" />}}\`
- **Operations**: Create/update via the same identifier; include status transitions and progress notes; add \`delete\` only when archiving.
- **Requirement**: Reflect the active task's status each iteration so progress is transparent.
```

**Updated Text:**
```javascript
### Task Tool
- **Format**: \`{{<task identifier="task_id" heading="Title" content="Work description" status="pending|ongoing|finished|paused" notes="Progress" />}}\`
- **Operations**: Create/update via the same identifier; include status transitions and progress notes; add \`delete\` only when archiving.
- **Requirement**: Reflect the active task's status each iteration so progress is transparent.
- **DataVault Reference Rule**: If task uses vault data, include vault reference in heading or notes
  - Example: \`heading="Process sales data [vault:q4_sales]"\`
  - Example: \`notes="Using dataset from vault:customer_list for analysis"\`
```

---

#### Task 5.3: Update Goal Tool Format Documentation
**Files to Modify:**
- `/js/config/app-config.js` (L146-149)

**Current Text:**
```javascript
### Goal Tool
- **Format**: \`{{<goal identifier="goal_id" heading="Success Criteria" content="Objectives" notes="Validation plan" />}}\`
- **Operations**: Create/update via the same identifier; add \`delete\` when retiring a goal.
- **Use Cases**: Describe measurable end states and how they will be validated.
```

**Updated Text:**
```javascript
### Goal Tool
- **Format**: \`{{<goal identifier="goal_id" heading="Success Criteria" content="Objectives" notes="Validation plan" />}}\`
- **Operations**: Create/update via the same identifier; add \`delete\` when retiring a goal.
- **Use Cases**: Describe measurable end states and how they will be validated.
- **DataVault Reference Rule**: If goal validation requires vault data, cite vault entries
  - Example: \`content="Validate model accuracy using [vault:test_dataset]"\`
  - Example: \`notes="Success measured against baseline in vault:benchmark_results"\`
```

---

## üîç VERIFICATION CHECKLIST

### **Phase 1 Verification:**
- [ ] Reasoning Log section has collapse toggle button
- [ ] Code Execution section has collapse toggle button
- [ ] Both sections collapse/expand correctly
- [ ] Toggle button changes between `+` and `‚àí`
- [ ] CSS classes `.collapsible` and `.collapsed` work correctly

### **Phase 2 Verification:**
- [ ] Attachment buttons show new, larger icons
- [ ] Icons are self-explanatory (üì•üíæüîÑüóëÔ∏è)
- [ ] Buttons maintain proper spacing and alignment
- [ ] Tooltip text matches new icon meanings

### **Phase 3 Verification:**
- [ ] Reasoning blocks have clear visual borders
- [ ] Even/odd iterations have different backgrounds
- [ ] Code execution blocks have color-coded borders
- [ ] Activity blocks have proper type-based styling
- [ ] Iteration badges are clearly visible
- [ ] Error messages have proper styling
- [ ] No overlapping or merged blocks

### **Phase 4 Verification:**
- [ ] Excel API reference mentions preview vs operation modes
- [ ] Character limit strategy clearly distinguishes 50 vs Infinity
- [ ] Exploration guide includes beginning/end/middle scanning
- [ ] Examples show correct usage of charLimit: Infinity
- [ ] Best practices updated with new rules
- [ ] Decision tree helps LLM choose correct limit

### **Phase 5 Verification:**
- [ ] System prompt includes vault reference requirement
- [ ] Task tool documentation mentions vault citations
- [ ] Goal tool documentation mentions vault citations
- [ ] Examples show proper vault reference format

---

## üìä IMPACT ANALYSIS

### **Files Modified:** 5
1. `/index.html` - UI structure changes
2. `/styles.css` - New styling rules
3. `/js/excel/core/excel-store.js` - Char limit constants (optional)
4. `/js/reasoning/context/providers/attachments-provider.js` - Excel prompts
5. `/js/config/app-config.js` - System instructions

### **Files Created:** 0

### **Breaking Changes:** None
- All changes are additive or clarifications
- Backward compatible with existing functionality
- No API signature changes

### **Testing Requirements:**
- Manual testing of collapse toggles
- Visual verification of reasoning log styling
- Excel API behavior testing with different charLimit values
- LLM prompt testing to verify vault reference inclusion

---

## üé® DESIGN TOKENS

### **Colors Used:**
- Reasoning: #0066cc (Blue)
- Execution: #00ff00 (Electric Green)
- Vault: #9933ff (Purple)
- Memory: #0099ff (Light Blue)
- Task: #00cc66 (Green)
- Goal: #ff6600 (Orange)
- Output: #cc0099 (Magenta)
- Error: #ff3366 (Red)
- Warning: #ff9933 (Orange)

### **Spacing:**
- Block separation: `var(--space-lg)` (16px)
- Internal padding: `var(--space-md)` (12px)
- Header padding: `var(--space-sm)` (8px)
- Icon size: 1.125rem (18px) for buttons, 1.25rem (20px) for activities

---

## ‚úÖ COMPLETION CRITERIA

1. **UI Collapsibility:**
   - Reasoning Log and Code Execution sections collapse/expand smoothly
   - Visual feedback (+ / ‚àí) updates correctly

2. **Attachment Icons:**
   - All 4 buttons show new, larger, self-explanatory icons
   - Icons are visually distinct and intuitive

3. **Reasoning Display:**
   - Clear visual separation between iterations
   - Color-coded execution blocks
   - Proper borders and backgrounds
   - Activity blocks styled by type

4. **Excel API:**
   - Documentation clearly explains preview vs operation modes
   - Exploration guide includes mandatory beginning/end scanning
   - Examples demonstrate correct charLimit usage
   - Decision tree helps choose appropriate limit

5. **System Instructions:**
   - Task and Goal tools documentation includes vault reference requirement
   - Examples show proper citation format
   - Main prompt emphasizes vault reference inclusion

---

## üìù NOTES

- The collapse toggle functionality might already exist in the codebase (check handler files)
- Reasoning block CSS classes are generated dynamically, not in styles.css currently
- Excel char limit default remains 50 for backward compatibility
- LLM behavior change is achieved through prompt updates, not code changes
- All styling follows existing Swiss monochrome design system
