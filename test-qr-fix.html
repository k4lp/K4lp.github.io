<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner - Fix Validation</title>
    <style>
        body { 
            font-family: 'Geist', system-ui, -apple-system, sans-serif;
            margin: 2rem;
            background: #fafafa;
            color: #111;
        }
        .status { padding: 1rem; margin: 1rem 0; border-radius: 8px; }
        .success { background: #e6ffed; border: 1px solid #4caf50; color: #2e7d32; }
        .error { background: #ffebee; border: 1px solid #f44336; color: #c62828; }
        .warning { background: #fff3e0; border: 1px solid #ff9800; color: #ef6c00; }
        .loading { background: #e3f2fd; border: 1px solid #2196f3; color: #1565c0; }
        pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; }
        button { 
            background: #111; 
            color: white; 
            border: none; 
            padding: 0.5rem 1rem; 
            border-radius: 4px; 
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover { background: #333; }
    </style>
</head>
<body>
    <h1>QR Scanner - Fix Validation</h1>
    <p>This page validates that the JavaScript errors have been fixed.</p>

    <div class="status loading" id="status">
        Loading QR Scanner modules...
    </div>

    <div id="results"></div>

    <div>
        <button onclick="runTests()">Run Tests</button>
        <button onclick="location.href='qrcode.html'">Go to QR Scanner</button>
        <button onclick="location.href='index.html'">Back to Index</button>
    </div>

    <!-- Load the QR scanner dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="/js/qrcode/utils.js"></script>

    <script>
        let testResults = [];

        function addResult(name, success, message, details = null) {
            testResults.push({ name, success, message, details });
            updateDisplay();
        }

        function updateDisplay() {
            const results = document.getElementById('results');
            const status = document.getElementById('status');
            
            let html = '<h2>Test Results:</h2>';
            let allPassed = true;
            
            testResults.forEach(result => {
                const statusClass = result.success ? 'success' : 'error';
                const icon = result.success ? '‚úÖ' : '‚ùå';
                
                html += `
                    <div class="status ${statusClass}">
                        <strong>${icon} ${result.name}</strong><br>
                        ${result.message}
                        ${result.details ? `<pre>${result.details}</pre>` : ''}
                    </div>
                `;
                
                if (!result.success) allPassed = false;
            });
            
            results.innerHTML = html;
            
            if (testResults.length > 0) {
                status.className = allPassed ? 'status success' : 'status error';
                status.textContent = allPassed 
                    ? `All ${testResults.length} tests passed! ‚úÖ` 
                    : `${testResults.filter(r => !r.success).length} tests failed ‚ùå`;
            }
        }

        function runTests() {
            testResults = [];
            updateDisplay();
            
            // Test 1: Check if Html5Qrcode is available
            try {
                if (typeof Html5Qrcode !== 'undefined') {
                    addResult('Html5Qrcode Library', true, 'Html5Qrcode library loaded successfully');
                } else {
                    addResult('Html5Qrcode Library', false, 'Html5Qrcode library not found');
                }
            } catch (error) {
                addResult('Html5Qrcode Library', false, 'Error checking Html5Qrcode: ' + error.message);
            }
            
            // Test 2: Check if XLSX is available
            try {
                if (typeof XLSX !== 'undefined') {
                    addResult('XLSX Library', true, 'XLSX library loaded successfully');
                } else {
                    addResult('XLSX Library', false, 'XLSX library not found');
                }
            } catch (error) {
                addResult('XLSX Library', false, 'Error checking XLSX: ' + error.message);
            }
            
            // Test 3: Check if QRUtils is available
            setTimeout(() => {
                try {
                    if (typeof QRUtils !== 'undefined') {
                        addResult('QRUtils Module', true, 'QRUtils module loaded successfully');
                    } else {
                        addResult('QRUtils Module', false, 'QRUtils module not found');
                    }
                } catch (error) {
                    addResult('QRUtils Module', false, 'Error checking QRUtils: ' + error.message);
                }
            }, 500);
            
            // Test 4: Test Html5Qrcode instantiation (the main error from before)
            setTimeout(() => {
                try {
                    // Create a dummy element for testing
                    const testDiv = document.createElement('div');
                    testDiv.id = 'test-qr-reader';
                    testDiv.style.display = 'none';
                    document.body.appendChild(testDiv);
                    
                    // Try to create Html5Qrcode instance
                    const testScanner = new Html5Qrcode('test-qr-reader');
                    
                    addResult('Html5Qrcode Instantiation', true, 'Html5Qrcode can be instantiated without errors');
                    
                    // Clean up
                    document.body.removeChild(testDiv);
                    
                } catch (error) {
                    addResult('Html5Qrcode Instantiation', false, 'Error creating Html5Qrcode instance: ' + error.message, error.stack);
                }
            }, 1000);
            
            // Test 5: Check module exports (the other error)
            setTimeout(() => {
                try {
                    // This should not throw an error in browser environment
                    const isNodeEnvironment = (typeof module !== 'undefined' && module.exports);
                    addResult('Module System Check', true, `Module system check passed. Node environment: ${isNodeEnvironment}`);
                } catch (error) {
                    addResult('Module System Check', false, 'Module system check failed: ' + error.message);
                }
            }, 1500);
            
            // Test 6: Camera API availability
            setTimeout(() => {
                try {
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        addResult('Camera API', true, 'getUserMedia API is available');
                    } else {
                        addResult('Camera API', false, 'getUserMedia API is not available');
                    }
                } catch (error) {
                    addResult('Camera API', false, 'Error checking camera API: ' + error.message);
                }
            }, 2000);

            // Test 7: Security context
            setTimeout(() => {
                try {
                    if (window.isSecureContext) {
                        addResult('Security Context', true, 'Running in secure context (HTTPS or localhost)');
                    } else {
                        addResult('Security Context', false, 'Not running in secure context - camera may not work');
                    }
                } catch (error) {
                    addResult('Security Context', false, 'Error checking security context: ' + error.message);
                }
            }, 2500);
        }

        // Run tests automatically when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                runTests();
            }, 500);
        });

        // Handle errors
        window.addEventListener('error', (event) => {
            addResult('JavaScript Error', false, `Global error caught: ${event.error.message}`, event.error.stack);
        });

        // Log when critical libraries load
        window.addEventListener('load', () => {
            console.log('üîç QR Scanner Fix Validation');
            console.log('üìã Html5Qrcode available:', typeof Html5Qrcode !== 'undefined');
            console.log('üìä XLSX available:', typeof XLSX !== 'undefined');
            console.log('üõ†Ô∏è Security context:', window.isSecureContext);
        });
    </script>
</body>
</html>